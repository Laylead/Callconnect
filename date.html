<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EliteConnect | Premium Chat Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #7c3aed;
            --primary-dark: #5b21b6;
            --secondary: #f472b6;
            --dark: #1f2937;
            --light: #f8fafc;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray: #6b7280;
            --gray-light: #e5e7eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: var(--light);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Auth Screen */
        .auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: radial-gradient(circle at 50% 50%, rgba(124, 58, 237, 0.1), transparent 70%);
        }

        .auth-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-card h2 {
            text-align: center;
            margin-bottom: 10px;
            color: white;
            font-size: 28px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-card p {
            text-align: center;
            color: var(--gray);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--gray-light);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
        }

        .gender-selector {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .gender-option {
            flex: 1;
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .gender-option:hover {
            background: rgba(124, 58, 237, 0.1);
        }

        .gender-option.selected {
            border-color: var(--primary);
            background: rgba(124, 58, 237, 0.2);
        }

        .gender-option i {
            font-size: 24px;
            margin-bottom: 8px;
            display: block;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(124, 58, 237, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
            padding-top: 20px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .wallet-card {
            background: linear-gradient(135deg, #7c3aed, #5b21b6);
            padding: 20px;
            border-radius: 15px;
            min-width: 250px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .wallet-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .wallet-card .balance {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .wallet-actions {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .model-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: fadeIn 0.6s ease-out;
            animation-fill-mode: both;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .model-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border-color: var(--primary);
        }

        .model-card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
        }

        .model-info {
            padding: 20px;
        }

        .model-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .model-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .status-online {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .status-offline {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .model-stats {
            display: flex;
            justify-content: space-between;
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 15px;
        }

        /* Chat Interface */
        .chat-interface {
            display: none;
            min-height: 100vh;
            padding-top: 20px;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .chat-partner-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-partner-info img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 70vh;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            position: relative;
            animation: messageAppear 0.3s ease-out;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-bottom-right-radius: 5px;
        }

        .message-received {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 5px;
        }

        .message-sender {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 4px;
        }

        .message-content {
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.5;
            text-align: right;
        }

        .voice-note {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-top: 5px;
        }

        .voice-note i {
            color: var(--secondary);
            font-size: 20px;
        }

        .media-request {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .media-request h4 {
            color: var(--warning);
            margin-bottom: 10px;
        }

        .media-request p {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .chat-input-area {
            padding: 20px;
            background: rgba(30, 41, 59, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            color: white;
            font-size: 16px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .action-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: var(--primary);
            transform: scale(1.1);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: scaleIn 0.3s ease-out;
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 24px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--gray);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: white;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success);
            color: white;
            border-radius: 10px;
            z-index: 1001;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s;
            display: none;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
            }
        }

        /* Loading Animation */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .auth-card {
                padding: 30px 20px;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 20px;
                align-items: stretch;
            }
            
            .wallet-card {
                min-width: auto;
            }
            
            .models-grid {
                grid-template-columns: 1fr;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-card">
            <h2>EliteConnect</h2>
            <p>Premium adult chat platform</p>
            
            <form id="authForm">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" class="form-control" id="email" required>
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                
                <div class="form-group">
                    <label>Select Gender</label>
                    <div class="gender-selector">
                        <div class="gender-option" data-gender="male">
                            <i class="fas fa-mars"></i>
                            <div>Male</div>
                        </div>
                        <div class="gender-option" data-gender="female">
                            <i class="fas fa-venus"></i>
                            <div>Female</div>
                        </div>
                    </div>
                    <input type="hidden" id="gender" required>
                </div>
                
                <button type="submit" class="btn btn-primary" id="authButton">
                    <span>Sign In</span>
                </button>
                
                <div style="text-align: center; margin-top: 20px; color: var(--gray);">
                    <span>Don't have an account? </span>
                    <a href="#" id="toggleAuth" style="color: var(--primary);">Sign Up</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard container" id="dashboard">
        <div class="dashboard-header">
            <div>
                <h1 style="font-size: 28px; margin-bottom: 5px;">Welcome, <span id="userName">User</span></h1>
                <p style="color: var(--gray);">Select a model to start chatting</p>
            </div>
            
            <div class="wallet-card">
                <h3>Wallet Balance</h3>
                <div class="balance">₦<span id="walletBalance">0</span></div>
                <div class="wallet-actions">
                    <button class="btn btn-success btn-sm" id="depositBtn">
                        <i class="fas fa-plus"></i> Deposit
                    </button>
                    <button class="btn btn-secondary btn-sm" id="withdrawBtn" style="display: none;">
                        <i class="fas fa-minus"></i> Withdraw
                    </button>
                </div>
            </div>
        </div>
        
        <div class="models-grid" id="modelsGrid">
            <!-- Models will be loaded here -->
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="chat-interface container" id="chatInterface">
        <div class="chat-header">
            <div class="chat-partner-info">
                <img src="" alt="Model" id="chatModelImage">
                <div>
                    <h3 id="chatModelName">Model Name</h3>
                    <div class="model-status status-online" id="chatModelStatus">
                        <i class="fas fa-circle"></i> Online
                    </div>
                </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="text-align: right;">
                    <div style="font-size: 14px; color: var(--gray);">Chat Cost</div>
                    <div style="font-size: 20px; font-weight: 600;">₦10/message</div>
                </div>
                <button class="btn btn-secondary" id="backToDashboard">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be loaded here -->
            </div>
            
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="messageInput" placeholder="Type your message...">
                <button class="action-btn" id="sendMediaRequestBtn" title="Request Media">
                    <i class="fas fa-image"></i>
                </button>
                <button class="action-btn" id="sendMessageBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Deposit Modal -->
    <div class="modal" id="depositModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Deposit Funds</h3>
                <button class="close-modal" id="closeDepositModal">&times;</button>
            </div>
            <div class="form-group">
                <label>Amount (₦)</label>
                <input type="number" class="form-control" id="depositAmount" min="100" value="1000">
            </div>
            <div class="form-group">
                <label>Payment Method</label>
                <select class="form-control" id="paymentMethod">
                    <option value="card">Credit/Debit Card</option>
                    <option value="bank">Bank Transfer</option>
                    <option value="crypto">Cryptocurrency</option>
                </select>
            </div>
            <button class="btn btn-primary" id="confirmDeposit">
                <i class="fas fa-lock"></i> Pay Securely
            </button>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal" id="withdrawModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Withdraw Earnings</h3>
                <button class="close-modal" id="closeWithdrawModal">&times;</button>
            </div>
            <div class="form-group">
                <label>Available Balance: ₦<span id="availableBalance">0</span></label>
                <input type="number" class="form-control" id="withdrawAmount" placeholder="Enter amount">
            </div>
            <div class="form-group">
                <label>Bank Account</label>
                <input type="text" class="form-control" id="bankAccount" placeholder="Account number">
            </div>
            <button class="btn btn-primary" id="confirmWithdraw">
                Request Withdrawal
            </button>
        </div>
    </div>

    <!-- Media Request Modal -->
    <div class="modal" id="mediaRequestModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Custom Media Request</h3>
                <button class="close-modal" id="closeMediaRequestModal">&times;</button>
            </div>
            <div class="form-group">
                <label>Media Type</label>
                <select class="form-control" id="mediaType">
                    <option value="image">Photo</option>
                    <option value="video">Video</option>
                </select>
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea class="form-control" id="mediaDescription" rows="3" placeholder="Describe what you'd like..."></textarea>
            </div>
            <div class="form-group">
                <label>Offer Amount (₦)</label>
                <input type="number" class="form-control" id="mediaPrice" min="100" value="500">
            </div>
            <button class="btn btn-primary" id="sendMediaRequest">
                Send Request
            </button>
        </div>
    </div>

    <!-- Media Upload Modal (For Models) -->
    <div class="modal" id="mediaUploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload Media</h3>
                <button class="close-modal" id="closeMediaUploadModal">&times;</button>
            </div>
            <div id="mediaRequestDetails">
                <!-- Request details will appear here -->
            </div>
            <div class="form-group">
                <label>Upload File</label>
                <input type="file" class="form-control" id="mediaFile" accept="image/*,video/*">
            </div>
            <button class="btn btn-success" id="uploadMedia">
                <i class="fas fa-upload"></i> Upload & Earn ₦<span id="earnAmount">0</span>
            </button>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- External Configurations (Will be replaced with actual config files) -->
    <script src="firebase-config.js"></script>
    <script src="agora.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC6nWtQO2jRk8Q8Yf9gB8nL7dXqY1Zz8vA",
            authDomain: "eliteconnect-chat.firebaseapp.com",
            projectId: "eliteconnect-chat",
            storageBucket: "eliteconnect-chat.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890"
        };

        // Agora Configuration
        const agoraConfig = {
            appId: "YOUR_AGORA_APP_ID",
            token: null // Will be generated server-side
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // State Management
        let currentUser = null;
        let currentChat = null;
        let isSignUp = false;
        let selectedGender = null;

        // DOM Elements
        const authScreen = document.getElementById('authScreen');
        const dashboard = document.getElementById('dashboard');
        const chatInterface = document.getElementById('chatInterface');
        const authForm = document.getElementById('authForm');
        const authButton = document.getElementById('authButton');
        const toggleAuth = document.getElementById('toggleAuth');
        const genderOptions = document.querySelectorAll('.gender-option');
        const genderInput = document.getElementById('gender');
        const modelsGrid = document.getElementById('modelsGrid');
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const backToDashboard = document.getElementById('backToDashboard');
        const depositBtn = document.getElementById('depositBtn');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const walletBalance = document.getElementById('walletBalance');
        const userName = document.getElementById('userName');
        const chatModelName = document.getElementById('chatModelName');
        const chatModelImage = document.getElementById('chatModelImage');
        const chatModelStatus = document.getElementById('chatModelStatus');

        // Initialize Gender Selection
        genderOptions.forEach(option => {
            option.addEventListener('click', () => {
                genderOptions.forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedGender = option.dataset.gender;
                genderInput.value = selectedGender;
            });
        });

        // Toggle between Sign In and Sign Up
        toggleAuth.addEventListener('click', (e) => {
            e.preventDefault();
            isSignUp = !isSignUp;
            authButton.innerHTML = isSignUp ? 
                '<i class="fas fa-user-plus"></i><span>Sign Up</span>' : 
                '<i class="fas fa-sign-in-alt"></i><span>Sign In</span>';
            toggleAuth.textContent = isSignUp ? 'Sign In' : 'Sign Up';
        });

        // Authentication
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const gender = selectedGender;

            if (!gender) {
                showNotification('Please select your gender', 'warning');
                return;
            }

            authButton.disabled = true;
            authButton.innerHTML = '<div class="loader"></div>';

            try {
                if (isSignUp) {
                    // Sign Up
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(userCredential.user.uid).set({
                        email,
                        gender,
                        balance: gender === 'male' ? 0 : 0,
                        earnings: gender === 'female' ? 0 : 0,
                        name: email.split('@')[0],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showNotification('Account created successfully!', 'success');
                } else {
                    // Sign In
                    await auth.signInWithEmailAndPassword(email, password);
                    showNotification('Signed in successfully!', 'success');
                }
            } catch (error) {
                console.error('Auth error:', error);
                showNotification(error.message, 'danger');
                authButton.disabled = false;
                authButton.innerHTML = isSignUp ? 
                    '<i class="fas fa-user-plus"></i><span>Sign Up</span>' : 
                    '<i class="fas fa-sign-in-alt"></i><span>Sign In</span>';
            }
        });

        // Auth State Observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                
                currentUser.data = userData;
                userName.textContent = userData.name;
                walletBalance.textContent = userData.balance || 0;
                
                // Show appropriate buttons based on gender
                if (userData.gender === 'female') {
                    withdrawBtn.style.display = 'inline-flex';
                    depositBtn.style.display = 'none';
                }
                
                authScreen.style.display = 'none';
                dashboard.style.display = 'block';
                loadModels();
            } else {
                currentUser = null;
                authScreen.style.display = 'flex';
                dashboard.style.display = 'none';
                chatInterface.style.display = 'none';
            }
        });

        // Load Models
        async function loadModels() {
            modelsGrid.innerHTML = '';
            
            try {
                const modelsSnapshot = await db.collection('users')
                    .where('gender', '==', 'female')
                    .limit(20)
                    .get();
                
                let animationDelay = 0;
                
                modelsSnapshot.forEach((doc, index) => {
                    const model = doc.data();
                    model.id = doc.id;
                    
                    const modelCard = document.createElement('div');
                    modelCard.className = 'model-card';
                    modelCard.style.animationDelay = `${animationDelay}ms`;
                    animationDelay += 100;
                    
                    modelCard.innerHTML = `
                        <img src="${model.photoURL || 'https://images.unsplash.com/photo-1494790108755-2616b786d4d1?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80'}" alt="${model.name}">
                        <div class="model-info">
                            <div class="model-name">${model.name}</div>
                            <div class="model-status ${model.online ? 'status-online' : 'status-offline'}">
                                <i class="fas fa-circle"></i> ${model.online ? 'Online' : 'Offline'}
                            </div>
                            <div class="model-stats">
                                <span><i class="fas fa-comment"></i> ${model.chats || 0} chats</span>
                                <span><i class="fas fa-star"></i> ${model.rating || 5}/5</span>
                            </div>
                            <button class="btn btn-primary" onclick="startChat('${model.id}')" style="width: 100%;">
                                <i class="fas fa-comment-dots"></i> Start Chat
                            </button>
                        </div>
                    `;
                    
                    modelsGrid.appendChild(modelCard);
                });
            } catch (error) {
                console.error('Error loading models:', error);
            }
        }

        // Start Chat
        window.startChat = async function(modelId) {
            try {
                const modelDoc = await db.collection('users').doc(modelId).get();
                const model = modelDoc.data();
                
                currentChat = {
                    modelId,
                    modelName: model.name,
                    modelPhoto: model.photoURL || 'https://images.unsplash.com/photo-1494790108755-2616b786d4d1?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=800&q=80'
                };
                
                chatModelName.textContent = model.name;
                chatModelImage.src = currentChat.modelPhoto;
                
                dashboard.style.display = 'none';
                chatInterface.style.display = 'block';
                
                loadChatMessages();
            } catch (error) {
                console.error('Error starting chat:', error);
                showNotification('Failed to start chat', 'danger');
            }
        };

        // Load Chat Messages
        async function loadChatMessages() {
            chatMessages.innerHTML = '';
            
            if (!currentUser || !currentChat) return;
            
            const chatId = [currentUser.uid, currentChat.modelId].sort().join('_');
            
            try {
                const messagesSnapshot = await db.collection('chats')
                    .doc(chatId)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .limit(50)
                    .get();
                
                messagesSnapshot.forEach(doc => {
                    const message = doc.data();
                    addMessageToUI(message, message.senderId === currentUser.uid);
                });
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                // Listen for new messages
                db.collection('chats')
                    .doc(chatId)
                    .collection('messages')
                    .orderBy('timestamp', 'asc')
                    .limitToLast(1)
                    .onSnapshot((snapshot) => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const message = change.doc.data();
                                addMessageToUI(message, message.senderId === currentUser.uid);
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                            }
                        });
                    });
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Send Message
        sendMessageBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message || !currentUser || !currentChat) return;
            
            if (currentUser.data.balance < 10 && currentUser.data.gender === 'male') {
                showNotification('Insufficient balance. Please deposit funds.', 'warning');
                return;
            }
            
            const chatId = [currentUser.uid, currentChat.modelId].sort().join('_');
            const messageData = {
                text: message,
                senderId: currentUser.uid,
                senderName: currentUser.data.name,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                type: 'text'
            };
            
            try {
                // Add message to Firestore
                await db.collection('chats').doc(chatId).collection('messages').add(messageData);
                
                // Update user's balance (deduct 10 Naira for males)
                if (currentUser.data.gender === 'male') {
                    await db.collection('users').doc(currentUser.uid).update({
                        balance: firebase.firestore.FieldValue.increment(-10)
                    });
                    
                    // Update model's earnings
                    await db.collection('users').doc(currentChat.modelId).update({
                        earnings: firebase.firestore.FieldValue.increment(10)
                    });
                    
                    // Update local balance
                    currentUser.data.balance -= 10;
                    walletBalance.textContent = currentUser.data.balance;
                }
                
                messageInput.value = '';
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Failed to send message', 'danger');
            }
        }

        // Add message to UI
        function addMessageToUI(message, isSent) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isSent ? 'message-sent' : 'message-received'}`;
            
            let content = `
                <div class="message-sender">${message.senderName}</div>
                <div class="message-content">${message.text}</div>
            `;
            
            if (message.type === 'voice') {
                content = `
                    <div class="message-sender">${message.senderName}</div>
                    <div class="voice-note">
                        <i class="fas fa-microphone"></i>
                        <div>Voice message</div>
                        <div style="margin-left: auto;">${message.duration || '0:10'}</div>
                    </div>
                `;
            } else if (message.type === 'media_request') {
                content = `
                    <div class="message-sender">${message.senderName}</div>
                    <div class="media-request">
                        <h4><i class="fas fa-image"></i> Custom ${message.mediaType} Request</h4>
                        <p><strong>Description:</strong> ${message.description}</p>
                        <p><strong>Offer:</strong> ₦${message.price}</p>
                        ${currentUser.data.gender === 'female' ? 
                            `<button class="btn btn-sm btn-success" onclick="showMediaUpload('${message.requestId}')">
                                Accept & Upload
                            </button>` : 
                            `<div style="font-size: 12px; color: var(--warning);">Waiting for model to accept...</div>`
                        }
                    </div>
                `;
            } else if (message.type === 'media') {
                const mediaTag = message.mediaType === 'image' ? 
                    `<img src="${message.url}" style="max-width: 100%; border-radius: 10px; margin-top: 5px;">` :
                    `<video src="${message.url}" controls style="max-width: 100%; border-radius: 10px; margin-top: 5px;"></video>`;
                
                content = `
                    <div class="message-sender">${message.senderName}</div>
                    <div>${message.caption || 'Media'}</div>
                    ${mediaTag}
                    <div style="font-size: 12px; color: var(--success); margin-top: 5px;">
                        <i class="fas fa-coins"></i> Earned: ₦${message.price || 0}
                    </div>
                `;
            }
            
            const time = message.timestamp ? 
                new Date(message.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) :
                new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = content + `<div class="message-time">${time}</div>`;
            chatMessages.appendChild(messageDiv);
        }

        // Navigation
        backToDashboard.addEventListener('click', () => {
            chatInterface.style.display = 'none';
            dashboard.style.display = 'block';
            currentChat = null;
        });

        // Deposit Funds
        depositBtn.addEventListener('click', () => {
            document.getElementById('depositModal').style.display = 'flex';
        });

        document.getElementById('closeDepositModal').addEventListener('click', () => {
            document.getElementById('depositModal').style.display = 'none';
        });

        document.getElementById('confirmDeposit').addEventListener('click', async () => {
            const amount = parseInt(document.getElementById('depositAmount').value);
            
            if (amount < 100) {
                showNotification('Minimum deposit is ₦100', 'warning');
                return;
            }
            
            // Simulate payment processing
            showNotification('Processing payment...', 'info');
            
            setTimeout(async () => {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        balance: firebase.firestore.FieldValue.increment(amount)
                    });
                    
                    currentUser.data.balance += amount;
                    walletBalance.textContent = currentUser.data.balance;
                    
                    document.getElementById('depositModal').style.display = 'none';
                    showNotification(`Successfully deposited ₦${amount}!`, 'success');
                } catch (error) {
                    console.error('Error depositing:', error);
                    showNotification('Deposit failed', 'danger');
                }
            }, 2000);
        });

        // Withdraw Earnings
        withdrawBtn.addEventListener('click', () => {
            document.getElementById('availableBalance').textContent = currentUser.data.earnings || 0;
            document.getElementById('withdrawModal').style.display = 'flex';
        });

        document.getElementById('closeWithdrawModal').addEventListener('click', () => {
            document.getElementById('withdrawModal').style.display = 'none';
        });

        document.getElementById('confirmWithdraw').addEventListener('click', async () => {
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const bankAccount = document.getElementById('bankAccount').value;
            
            if (amount > (currentUser.data.earnings || 0)) {
                showNotification('Insufficient earnings', 'warning');
                return;
            }
            
            if (!bankAccount || bankAccount.length < 10) {
                showNotification('Please enter a valid bank account', 'warning');
                return;
            }
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    earnings: firebase.firestore.FieldValue.increment(-amount)
                });
                
                // Record withdrawal
                await db.collection('withdrawals').add({
                    userId: currentUser.uid,
                    amount,
                    bankAccount,
                    status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                currentUser.data.earnings -= amount;
                document.getElementById('withdrawModal').style.display = 'none';
                showNotification(`Withdrawal request for ₦${amount} submitted!`, 'success');
            } catch (error) {
                console.error('Error withdrawing:', error);
                showNotification('Withdrawal failed', 'danger');
            }
        });

        // Media Request
        document.getElementById('sendMediaRequestBtn').addEventListener('click', () => {
            if (currentUser.data.gender !== 'male') {
                showNotification('Only male users can request custom media', 'warning');
                return;
            }
            
            document.getElementById('mediaRequestModal').style.display = 'flex';
        });

        document.getElementById('closeMediaRequestModal').addEventListener('click', () => {
            document.getElementById('mediaRequestModal').style.display = 'none';
        });

        document.getElementById('sendMediaRequest').addEventListener('click', async () => {
            const mediaType = document.getElementById('mediaType').value;
            const description = document.getElementById('mediaDescription').value;
            const price = parseInt(document.getElementById('mediaPrice').value);
            
            if (price > currentUser.data.balance) {
                showNotification('Insufficient balance', 'warning');
                return;
            }
            
            if (price < 100) {
                showNotification('Minimum offer is ₦100', 'warning');
                return;
            }
            
            const requestId = Date.now().toString();
            const chatId = [currentUser.uid, currentChat.modelId].sort().join('_');
            
            const requestData = {
                type: 'media_request',
                senderId: currentUser.uid,
                senderName: currentUser.data.name,
                mediaType,
                description,
                price,
                requestId,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending'
            };
            
            try {
                await db.collection('chats').doc(chatId).collection('messages').add(requestData);
                
                // Store request details
                await db.collection('media_requests').doc(requestId).set({
                    ...requestData,
                    chatId,
                    modelId: currentChat.modelId,
                    clientId: currentUser.uid
                });
                
                document.getElementById('mediaRequestModal').style.display = 'none';
                showNotification('Media request sent!', 'success');
            } catch (error) {
                console.error('Error sending media request:', error);
                showNotification('Failed to send request', 'danger');
            }
        });

        // Show Media Upload Modal
        window.showMediaUpload = async function(requestId) {
            try {
                const requestDoc = await db.collection('media_requests').doc(requestId).get();
                const request = requestDoc.data();
                
                document.getElementById('mediaRequestDetails').innerHTML = `
                    <div class="media-request" style="margin-bottom: 20px;">
                        <h4><i class="fas fa-image"></i> ${request.mediaType} Request</h4>
                        <p><strong>Client:</strong> ${request.senderName}</p>
                        <p><strong>Description:</strong> ${request.description}</p>
                        <p><strong>Earnings:</strong> ₦${request.price}</p>
                    </div>
                `;
                
                document.getElementById('earnAmount').textContent = request.price;
                document.getElementById('mediaUploadModal').dataset.requestId = requestId;
                document.getElementById('mediaUploadModal').style.display = 'flex';
            } catch (error) {
                console.error('Error loading request:', error);
            }
        };

        document.getElementById('closeMediaUploadModal').addEventListener('click', () => {
            document.getElementById('mediaUploadModal').style.display = 'none';
        });

        // Upload Media
        document.getElementById('uploadMedia').addEventListener('click', async () => {
            const fileInput = document.getElementById('mediaFile');
            const file = fileInput.files[0];
            const requestId = document.getElementById('mediaUploadModal').dataset.requestId;
            
            if (!file) {
                showNotification('Please select a file', 'warning');
                return;
            }
            
            try {
                const requestDoc = await db.collection('media_requests').doc(requestId).get();
                const request = requestDoc.data();
                
                // Upload file to Firebase Storage
                const storageRef = storage.ref(`media/${currentUser.uid}/${Date.now()}_${file.name}`);
                const uploadTask = storageRef.put(file);
                
                showNotification('Uploading media...', 'info');
                
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Progress
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload progress:', progress);
                    },
                    (error) => {
                        console.error('Upload error:', error);
                        showNotification('Upload failed', 'danger');
                    },
                    async () => {
                        // Upload complete
                        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                        
                        // Add message to chat
                        const chatId = request.chatId;
                        const messageData = {
                            type: 'media',
                            senderId: currentUser.uid,
                            senderName: currentUser.data.name,
                            mediaType: request.mediaType,
                            url: downloadURL,
                            caption: request.description,
                            price: request.price,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        await db.collection('chats').doc(chatId).collection('messages').add(messageData);
                        
                        // Update request status
                        await db.collection('media_requests').doc(requestId).update({
                            status: 'completed',
                            mediaUrl: downloadURL,
                            completedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Update model's earnings
                        await db.collection('users').doc(currentUser.uid).update({
                            earnings: firebase.firestore.FieldValue.increment(request.price)
                        });
                        
                        // Deduct from client's balance
                        await db.collection('users').doc(request.clientId).update({
                            balance: firebase.firestore.FieldValue.increment(-request.price)
                        });
                        
                        document.getElementById('mediaUploadModal').style.display = 'none';
                        fileInput.value = '';
                        showNotification('Media uploaded successfully! Payment processed.', 'success');
                    }
                );
            } catch (error) {
                console.error('Error uploading media:', error);
                showNotification('Upload failed', 'danger');
            }
        });

        // Show Notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.background = type === 'success' ? 'var(--success)' :
                                          type === 'warning' ? 'var(--warning)' :
                                          type === 'danger' ? 'var(--danger)' :
                                          type === 'info' ? 'var(--primary)' : 'var(--dark)';
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Initialize Voice Note Feature (Agora)
        let agoraClient = null;
        let localStream = null;

        async function initAgora() {
            if (!agoraConfig.appId || agoraConfig.appId === 'YOUR_AGORA_APP_ID') {
                console.warn('Agora App ID not configured');
                return;
            }

            agoraClient = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
            
            // For simplicity, we'll show the voice note button for female users
            if (currentUser.data.gender === 'female') {
                const voiceBtn = document.createElement('button');
                voiceBtn.className = 'action-btn';
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceBtn.title = 'Send Voice Note';
                voiceBtn.onclick = startVoiceRecording;
                
                document.querySelector('.chat-input-area').insertBefore(
                    voiceBtn, 
                    document.getElementById('sendMediaRequestBtn')
                );
            }
        }

        async function startVoiceRecording() {
            if (!currentChat) return;
            
            try {
                // Request microphone access
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // In a real app, you would:
                // 1. Join Agora channel
                // 2. Record audio
                // 3. Upload to Firebase Storage
                // 4. Send message with audio URL
                
                showNotification('Voice recording started - implementation needed', 'info');
                
                // For now, simulate voice message
                setTimeout(() => {
                    const chatId = [currentUser.uid, currentChat.modelId].sort().join('_');
                    const messageData = {
                        type: 'voice',
                        senderId: currentUser.uid,
                        senderName: currentUser.data.name,
                        duration: '0:10',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    db.collection('chats').doc(chatId).collection('messages').add(messageData);
                    
                    // Update earnings for female users
                    if (currentUser.data.gender === 'female') {
                        db.collection('users').doc(currentUser.uid).update({
                            earnings: firebase.firestore.FieldValue.increment(10)
                        });
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error accessing microphone:', error);
                showNotification('Microphone access denied', 'danger');
            }
        }

        // Initialize on auth state change
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Wait a bit for UI to load
                setTimeout(initAgora, 1000);
            }
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // Initialize with some sample models if needed
        window.addEventListener('DOMContentLoaded', () => {
            // Add animation to auth card
            const authCard = document.querySelector('.auth-card');
            authCard.style.animation = 'fadeInUp 0.6s ease-out';
        });
    </script>
</body>
</html>
