<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Watch Party (HTML5 / YouTube) | Let's Connect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ===== CSS Variables & Reset ===== */
        :root {
            /* Color Branding */
            --primary-deep: #6A0DFF;
            --primary-medium: #8A4FFF;
            --primary-light: #CBB2FF;
            --accent-magenta: #D300FF;
            --accent-yellow: #FFC93C;
            --accent-green: #00D26A;
            --accent-red: #FF4757;
            --accent-blue: #3498db;
            
            /* Dark Mode Gradients */
            --gradient-dark: linear-gradient(160deg, #0F0525 0%, #09001F 50%, #050016 100%);
            --gradient-hero: linear-gradient(145deg, #6A0DFF 0%, #8A4FFF 40%, #CBB2FF 100%);
            --gradient-button: linear-gradient(135deg, #6A0DFF, #D300FF, #8A4FFF);
            --gradient-glow: radial-gradient(circle at top left, #D300FF 0%, #6A0DFFF 100%);
            --gradient-success: linear-gradient(135deg, #00D26A, #00FF88);
            --gradient-card: linear-gradient(145deg, rgba(26, 4, 58, 0.8), rgba(9, 0, 31, 0.9));
            
            /* Text Colors */
            --text-primary: #F8F8FF;
            --text-secondary: #B0B0D0;
            --text-accent: #CBB2FF;
            
            /* UI Elements */
            --frosted-bg: rgba(255, 255, 255, 0.1);
            --frosted-border: rgba(255, 255, 255, 0.15);
            --card-radius: 24px;
            --button-radius: 16px;
            --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
            --transition-fast: all 0.2s ease;
            
            /* Spacing */
            --spacing-xs: 8px;
            --spacing-sm: 16px;
            --spacing-md: 24px;
            --spacing-lg: 40px;
            --spacing-xl: 64px;
            
            /* Shadows */
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 25px 80px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 40px rgba(106, 13, 255, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', sans-serif;
        }

        body {
            background: var(--gradient-dark);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(106, 13, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(211, 0, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(138, 79, 255, 0.1) 0%, transparent 70%);
            pointer-events: none;
            z-index: -1;
        }

        /* ===== Loading Animation ===== */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-dark);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.6s ease;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient-button);
            position: relative;
            animation: pulseGlow 1.5s ease-in-out infinite;
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-spinner::before {
            content: '';
            position: absolute;
            inset: -6px;
            border-radius: 50%;
            background: var(--gradient-button);
            filter: blur(12px);
            opacity: 0.6;
            z-index: -1;
        }

        .loading-spinner i {
            font-size: 32px;
            color: white;
            animation: spin 1.5s linear infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ===== Animated Logo Text ===== */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 32px;
            font-weight: 800;
            color: var(--text-primary);
            text-decoration: none;
            font-family: 'Poppins', sans-serif;
            position: relative;
        }

        .logo-static {
            background: linear-gradient(135deg, var(--primary-medium), var(--accent-magenta));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            letter-spacing: -0.5px;
        }

        .logo-animated {
            position: relative;
            background: var(--gradient-hero);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            min-width: 140px;
            text-align: left;
            display: inline-block;
            letter-spacing: -0.5px;
        }

        .logo-animated::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--gradient-hero);
            border-radius: 2px;
            transform: scaleX(0);
            transform-origin: left;
            animation: underlineExpand 2.5s ease-in-out infinite;
        }

        @keyframes underlineExpand {
            0%, 50% { transform: scaleX(0); opacity: 0; }
            60%, 90% { transform: scaleX(1); opacity: 1; }
            100% { transform: scaleX(0); opacity: 0; }
        }

        /* ===== Main Container & Layout ===== */
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: var(--spacing-md);
            position: relative;
        }

        /* ===== Enhanced Header ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) 0;
            margin-bottom: var(--spacing-xl);
            position: relative;
            animation: slideDown 0.6s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .header-actions {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
        }

        /* ===== Enhanced User Info ===== */
        .user-info-container {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .user-info-btn {
            padding: 12px 20px;
            background: var(--frosted-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--frosted-border);
            border-radius: var(--button-radius);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 60px;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .user-info-btn:hover {
            background: rgba(138, 79, 255, 0.25);
            border-color: rgba(138, 79, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .user-info-btn:active {
            transform: translateY(0);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-button);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(106, 13, 255, 0.4);
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ===== Enhanced Action Buttons ===== */
        .action-btn {
            padding: 14px 28px;
            border-radius: var(--button-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: none;
            font-size: 15px;
            position: relative;
            overflow: hidden;
            text-decoration: none;
            letter-spacing: 0.3px;
        }

        .home-btn {
            background: var(--frosted-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--frosted-border);
            color: var(--text-primary);
        }

        .home-btn:hover {
            background: rgba(138, 79, 255, 0.25);
            border-color: rgba(138, 79, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 
                0 12px 30px rgba(106, 13, 255, 0.25),
                var(--shadow-glow);
        }

        .logout-btn {
            background: rgba(255, 71, 87, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 71, 87, 0.3);
            color: var(--text-primary);
            padding: 14px 24px;
            min-width: 120px;
        }

        .logout-btn:hover {
            background: rgba(255, 71, 87, 0.2);
            border-color: rgba(255, 71, 87, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(255, 71, 87, 0.2);
        }

        .action-btn i {
            font-size: 16px;
            transition: transform 0.3s ease;
        }

        .action-btn:hover i {
            transform: translateX(3px);
        }

        /* ===== Main Content ===== */
        .main-content {
            max-width: 680px;
            margin: 0 auto;
            width: 100%;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        @keyframes fadeInUp {
            from { transform: translateY(40px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ===== Enhanced Create Party Card ===== */
        .create-card {
            background: var(--gradient-card);
            backdrop-filter: blur(30px);
            border: 1px solid var(--frosted-border);
            border-radius: var(--card-radius);
            padding: var(--spacing-xl);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            margin-bottom: 60px;
            box-shadow: var(--shadow-xl);
        }

        .create-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--gradient-button);
            border-radius: var(--card-radius) var(--card-radius) 0 0;
        }

        .create-card::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(106, 13, 255, 0.1) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.6s ease;
            z-index: -1;
        }

        .create-card:hover::after {
            opacity: 1;
        }

        .create-card:hover {
            transform: translateY(-8px);
            border-color: rgba(138, 79, 255, 0.5);
            box-shadow: 
                var(--shadow-xl),
                0 0 60px rgba(106, 13, 255, 0.3);
        }

        .card-title {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 40px;
            font-family: 'Poppins', sans-serif;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .card-title i {
            color: var(--primary-medium);
            font-size: 40px;
            filter: drop-shadow(0 0 20px rgba(106, 13, 255, 0.6));
        }

        /* ===== Enhanced Form Elements ===== */
        .form-group {
            margin-bottom: 32px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 12px;
            font-weight: 700;
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-label i {
            color: var(--primary-light);
            font-size: 16px;
        }

        .form-input {
            width: 100%;
            padding: 18px 24px;
            border-radius: var(--button-radius);
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.4);
            color: var(--text-primary);
            font-size: 16px;
            transition: var(--transition);
            font-family: 'Inter', sans-serif;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-medium);
            background: rgba(0, 0, 0, 0.6);
            box-shadow: 
                0 0 0 4px rgba(106, 13, 255, 0.25),
                inset 0 0 30px rgba(255, 255, 255, 0.05);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        /* ===== Enhanced Radio Button Group ===== */
        .radio-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 12px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            cursor: pointer;
            padding: 20px;
            border-radius: 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .radio-label::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-button);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .radio-label:hover {
            background: rgba(106, 13, 255, 0.15);
            border-color: rgba(106, 13, 255, 0.3);
            transform: translateY(-2px);
        }

        .radio-label.selected {
            background: rgba(106, 13, 255, 0.25);
            border-color: var(--primary-medium);
            box-shadow: 
                0 8px 30px rgba(106, 13, 255, 0.3),
                inset 0 0 20px rgba(255, 255, 255, 0.05);
        }

        .radio-label.selected::before {
            transform: scaleX(1);
        }

        .radio-label input[type="radio"] {
            display: none;
        }

        .radio-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .radio-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.05);
        }

        .radio-label.selected .radio-icon {
            border-color: var(--primary-medium);
            background: var(--primary-medium);
            box-shadow: 0 0 20px rgba(106, 13, 255, 0.5);
        }

        .radio-label.selected .radio-icon::after {
            content: '';
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
        }

        .radio-text {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 15px;
        }

        .radio-label.selected .radio-text {
            color: var(--text-primary);
        }

        .radio-icon-large {
            font-size: 20px;
            color: var(--primary-light);
            opacity: 0.8;
        }

        /* ===== Enhanced Buttons ===== */
        .btn {
            padding: 20px 40px;
            border-radius: var(--button-radius);
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            border: none;
            font-size: 17px;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.5px;
            width: 100%;
            backdrop-filter: blur(20px);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: var(--gradient-button);
            color: white;
            box-shadow: 
                0 0 40px rgba(106, 13, 255, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-4px);
            box-shadow: 
                0 0 60px rgba(106, 13, 255, 0.8),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            background: linear-gradient(135deg, #6A0DFF, #D300FF, #8A4FFF);
        }

        .btn-primary:active {
            transform: translateY(-2px);
        }

        /* ===== Enhanced Output Section ===== */
        .output-section {
            margin-top: 40px;
            padding-top: 32px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideInUp 0.6s ease-out;
        }

        @keyframes slideInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .output-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'Poppins', sans-serif;
        }

        .output-title i {
            color: var(--accent-green);
            font-size: 24px;
            filter: drop-shadow(0 0 20px rgba(0, 210, 106, 0.6));
        }

        .link-group {
            margin-bottom: 24px;
            background: rgba(0, 0, 0, 0.3);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .link-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 6px;
            height: 100%;
            background: var(--gradient-button);
            opacity: 0.8;
        }

        .link-group:hover {
            background: rgba(0, 0, 0, 0.4);
            border-color: rgba(138, 79, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
        }

        .link-label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .link-label i {
            color: var(--primary-light);
            font-size: 14px;
        }

        .link-container {
            display: flex;
            gap: 16px;
            align-items: stretch;
        }

        .link-input {
            flex: 1;
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            font-size: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            overflow-x: auto;
            white-space: nowrap;
            transition: var(--transition);
            min-height: 56px;
            display: flex;
            align-items: center;
        }

        .link-input:focus {
            outline: none;
            border-color: var(--primary-medium);
            color: var(--text-primary);
        }

        .link-btn {
            padding: 16px 28px;
            min-width: auto;
            background: var(--frosted-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--frosted-border);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            white-space: nowrap;
        }

        .link-btn:hover {
            background: var(--primary-medium);
            border-color: var(--primary-medium);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 25px rgba(106, 13, 255, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .link-btn:active {
            transform: translateY(0);
        }

        .link-btn i {
            font-size: 16px;
        }

        /* ===== Enhanced Popular Parties Section ===== */
        .popular-parties {
            margin-top: 80px;
            animation: fadeInUp 0.8s ease-out 0.6s both;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 16px;
            font-family: 'Poppins', sans-serif;
        }

        .section-title i {
            color: var(--accent-yellow);
            filter: drop-shadow(0 0 25px rgba(255, 201, 60, 0.8));
            font-size: 32px;
        }

        .refresh-btn {
            padding: 14px 28px;
            border-radius: var(--button-radius);
            background: var(--frosted-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--frosted-border);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
        }

        .refresh-btn:hover {
            color: var(--text-primary);
            background: rgba(138, 79, 255, 0.2);
            border-color: rgba(138, 79, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(106, 13, 255, 0.25);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .refresh-btn.spinning i {
            animation: spin 1s linear infinite;
        }

        .parties-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 32px;
        }

        .party-item {
            background: var(--gradient-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--frosted-border);
            border-radius: 20px;
            padding: 28px;
            display: flex;
            gap: 24px;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .party-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--gradient-button);
            transform: scaleX(0);
            transition: transform 0.4s ease;
        }

        .party-item:hover::before {
            transform: scaleX(1);
        }

        .party-item:hover {
            transform: translateY(-8px);
            border-color: rgba(138, 79, 255, 0.4);
            box-shadow: 
                var(--shadow-xl),
                0 0 40px rgba(106, 13, 255, 0.25);
        }

        .party-thumbnail {
            width: 120px;
            height: 180px;
            border-radius: 14px;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }

        .party-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease;
        }

        .party-item:hover .party-thumbnail img {
            transform: scale(1.1);
        }

        .party-thumbnail::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent 40%, rgba(0, 0, 0, 0.9));
            border-radius: 14px;
        }

        .popular-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: linear-gradient(135deg, #FFC93C, #FF9F1C);
            color: #000;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 2;
            box-shadow: 0 6px 20px rgba(255, 201, 60, 0.4);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .party-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .party-name {
            font-weight: 800;
            font-size: 22px;
            margin-bottom: 8px;
            color: var(--text-primary);
            line-height: 1.3;
            font-family: 'Poppins', sans-serif;
        }

        .party-host {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .party-host i {
            color: var(--primary-light);
            font-size: 14px;
        }

        .party-meta {
            display: flex;
            gap: 24px;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .party-meta span {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }

        .party-meta i {
            color: var(--primary-light);
            font-size: 14px;
        }

        .viewer-count {
            color: var(--accent-yellow) !important;
            font-weight: 700;
            font-size: 16px;
        }

        .join-btn-small {
            padding: 14px 28px;
            background: var(--gradient-button);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            align-self: flex-start;
            box-shadow: 0 0 25px rgba(106, 13, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .join-btn-small:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 40px rgba(106, 13, 255, 0.7);
        }

        .no-parties {
            grid-column: 1 / -1;
            text-align: center;
            padding: 80px 40px;
            color: var(--text-secondary);
            background: var(--gradient-card);
            backdrop-filter: blur(20px);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            transition: var(--transition);
        }

        .no-parties:hover {
            background: rgba(138, 79, 255, 0.1);
            border-color: rgba(138, 79, 255, 0.3);
        }

        .no-parties i {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.5;
            color: var(--primary-light);
        }

        .no-parties h3 {
            font-size: 24px;
            color: var(--text-primary);
            margin-bottom: 16px;
            font-weight: 700;
        }

        .no-parties p {
            font-size: 16px;
            max-width: 400px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* ===== Enhanced Toast Notifications ===== */
        .toast {
            position: fixed;
            bottom: 40px;
            right: 40px;
            background: var(--gradient-card);
            backdrop-filter: blur(30px);
            border: 1px solid var(--frosted-border);
            border-radius: 16px;
            padding: 24px;
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 16px;
            transform: translateX(400px);
            opacity: 0;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
            z-index: 1000;
            box-shadow: var(--shadow-xl);
            max-width: 400px;
            min-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast i {
            font-size: 24px;
        }

        .toast.error {
            border-color: rgba(255, 71, 87, 0.4);
            background: linear-gradient(145deg, rgba(255, 71, 87, 0.1), rgba(155, 0, 0, 0.2));
        }

        .toast.error i {
            color: var(--accent-red);
        }

        .toast.success {
            border-color: rgba(0, 210, 106, 0.4);
            background: linear-gradient(145deg, rgba(0, 210, 106, 0.1), rgba(0, 155, 80, 0.2));
        }

        .toast.success i {
            color: var(--accent-green);
        }

        .toast.warning {
            border-color: rgba(255, 201, 60, 0.4);
            background: linear-gradient(145deg, rgba(255, 201, 60, 0.1), rgba(200, 150, 0, 0.2));
        }

        .toast.warning i {
            color: var(--accent-yellow);
        }

        /* ===== Live Link Generation Status ===== */
        .link-status {
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .link-status i {
            font-size: 14px;
        }

        .status-live {
            color: var(--accent-green);
        }

        .status-processing {
            color: var(--accent-yellow);
        }

        .status-error {
            color: var(--accent-red);
        }

        /* ===== Mobile Responsiveness ===== */
        @media (max-width: 1200px) {
            .parties-list {
                grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            }
        }

        @media (max-width: 992px) {
            .container {
                padding: 20px;
            }
            
            .create-card {
                padding: 32px;
            }
            
            .card-title {
                font-size: 32px;
            }
            
            .section-title {
                font-size: 24px;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 24px;
            }
            
            .header-actions {
                width: 100%;
                flex-wrap: wrap;
                justify-content: space-between;
            }
            
            .user-info-container {
                order: 2;
                width: 100%;
                justify-content: center;
                margin-top: 16px;
            }
            
            .action-buttons {
                display: flex;
                gap: 12px;
                order: 1;
                width: 100%;
                justify-content: center;
            }
            
            .home-btn, .logout-btn {
                flex: 1;
                min-width: 0;
                padding: 14px 20px;
            }
            
            .parties-list {
                grid-template-columns: 1fr;
            }
            
            .party-item {
                flex-direction: column;
            }
            
            .party-thumbnail {
                width: 100%;
                height: 200px;
            }
            
            .logo-container {
                font-size: 28px;
                justify-content: center;
            }
            
            .logo-animated {
                min-width: 120px;
            }
            
            .radio-group {
                grid-template-columns: 1fr;
            }
            
            .toast {
                bottom: 20px;
                right: 20px;
                left: 20px;
                max-width: none;
                min-width: 0;
            }
        }

        @media (max-width: 576px) {
            .container {
                padding: 16px;
            }
            
            .create-card {
                padding: 24px;
            }
            
            .card-title {
                font-size: 28px;
                margin-bottom: 32px;
            }
            
            .btn {
                padding: 18px 24px;
                font-size: 16px;
            }
            
            .link-container {
                flex-direction: column;
            }
            
            .link-btn {
                width: 100%;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }
            
            .refresh-btn {
                align-self: stretch;
            }
            
            .form-input {
                padding: 16px 20px;
            }
            
            .logo-container {
                font-size: 24px;
            }
        }

        @media (max-width: 480px) {
            .action-buttons {
                flex-direction: column;
            }
            
            .home-btn, .logout-btn {
                width: 100%;
            }
            
            .party-meta {
                flex-direction: column;
                gap: 12px;
            }
            
            .card-title {
                font-size: 24px;
            }
            
            .output-title {
                font-size: 20px;
            }
        }

        /* ===== Utility Classes ===== */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-in-right {
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* ===== Floating Elements ===== */
        .floating-bg {
            position: fixed;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .floating-element {
            position: absolute;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--primary-medium) 0%, transparent 70%);
            opacity: 0.1;
            animation: float 20s infinite ease-in-out;
        }

        .floating-element:nth-child(1) {
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .floating-element:nth-child(2) {
            top: 60%;
            right: 10%;
            animation-delay: -5s;
        }

        .floating-element:nth-child(3) {
            bottom: 20%;
            left: 20%;
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(30px, -50px) rotate(120deg); }
            66% { transform: translate(-20px, 20px) rotate(240deg); }
        }
    </style>
</head>
<body>
    <!-- Floating Background Elements -->
    <div class="floating-bg">
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-spinner">
            <i class="fas fa-film"></i>
        </div>
        <h3 class="logo-container" style="margin-bottom: 20px;">
            <span class="logo-static">Let's </span>
            <span class="logo-animated">Connect</span>
        </h3>
        <p style="color: var(--text-secondary); font-size: 16px;">Preparing your ultimate watch party experience...</p>
    </div>

    <!-- Main Container -->
    <div class="container hidden">
        <!-- Header -->
        <div class="header">
            <a href="#" class="logo-container">
                <span class="logo-static">Let's </span>
                <span id="animated-logo" class="logo-animated">Connect</span>
            </a>
            
            <div class="header-actions">
                <div class="user-info-container">
                    <div id="user-info-btn" class="user-info-btn hidden">
                        <div class="user-avatar" id="user-avatar">U</div>
                        <span class="user-name" id="user-name">Loading...</span>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <a href="home.html" class="action-btn home-btn">
                        <i class="fas fa-home"></i>
                        Home
                    </a>
                    <button id="logout-btn" class="action-btn logout-btn hidden">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Create Party Card -->
            <div class="create-card">
                <h2 class="card-title">
                    <i class="fas fa-video"></i>
                    Create Watch Party
                </h2>
                
                <form id="create-form">
                    <div class="form-group">
                        <label for="videoLink" class="form-label">
                            <i class="fas fa-link"></i>
                            Video Link
                        </label>
                        <input type="text" id="videoLink" class="form-input" 
                               placeholder="Paste YouTube, Vimeo, or direct MP4/HLS link" required>
                        <div class="link-status">
                            <i class="fas fa-circle status-processing"></i>
                            <span id="link-status-text">Enter a valid video link to generate watch party</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="startTime" class="form-label">
                            <i class="fas fa-clock"></i>
                            Start Time
                        </label>
                        <input type="datetime-local" id="startTime" class="form-input" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="roomName" class="form-label">
                            <i class="fas fa-heading"></i>
                            Room Name
                        </label>
                        <input type="text" id="roomName" class="form-input" 
                               placeholder="Give your watch party a cool name (optional)">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-eye"></i>
                            Room Visibility
                        </label>
                        <div class="radio-group">
                            <label class="radio-label selected" id="public-label">
                                <div class="radio-content">
                                    <div class="radio-icon"></div>
                                    <span class="radio-text">Public</span>
                                </div>
                                <i class="fas fa-globe radio-icon-large"></i>
                                <input type="radio" name="visibility" value="public" checked>
                            </label>
                            <label class="radio-label" id="private-label">
                                <div class="radio-content">
                                    <div class="radio-icon"></div>
                                    <span class="radio-text">Private</span>
                                </div>
                                <i class="fas fa-lock radio-icon-large"></i>
                                <input type="radio" name="visibility" value="private">
                            </label>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="create-btn">
                        <i class="fas fa-plus-circle"></i> Create Watch Party
                    </button>
                </form>

                <!-- Output Section -->
                <div id="output-section" class="output-section hidden">
                    <div class="output-title">
                        <i class="fas fa-check-circle"></i>
                        Watch Party Created!
                    </div>
                    
                    <div class="link-group">
                        <div class="link-label">
                            <i class="fas fa-crown"></i>
                            Host Link
                        </div>
                        <div class="link-container">
                            <input type="text" id="host-link" class="link-input" readonly>
                            <button class="link-btn" onclick="copyLink('host-link')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                    
                    <div class="link-group">
                        <div class="link-label">
                            <i class="fas fa-users"></i>
                            Viewer Link
                        </div>
                        <div class="link-container">
                            <input type="text" id="viewer-link" class="link-input" readonly>
                            <button class="link-btn" onclick="copyLink('viewer-link')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                    
                    <div class="link-group">
                        <div class="link-label">
                            <i class="fas fa-key"></i>
                            Room ID
                        </div>
                        <div class="link-container">
                            <input type="text" id="room-id" class="link-input" readonly>
                            <button class="link-btn" onclick="copyLink('room-id')">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popular Parties Section -->
        <div class="popular-parties">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-fire"></i>
                    ðŸ”¥ Popular Live Parties
                </h3>
                <button class="refresh-btn" id="refresh-parties">
                    <i class="fas fa-redo"></i>
                    Refresh
                </button>
            </div>
            
            <div class="parties-list" id="popular-parties-list">
                <!-- Popular parties will be loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Link copied to clipboard!</span>
    </div>

    <!-- External Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="agora.js"></script>
    
    <script>
        // ===== Initialize Firebase =====
        // Already initialized in firebase-config.js
        const db = firebase.database();
        const auth = firebase.auth();

        // ===== DOM Elements =====
        const loadingScreen = document.getElementById('loading-screen');
        const mainContainer = document.querySelector('.container');
        const createForm = document.getElementById('create-form');
        const outputSection = document.getElementById('output-section');
        const popularPartiesList = document.getElementById('popular-parties-list');
        const refreshPartiesBtn = document.getElementById('refresh-parties');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const animatedLogo = document.getElementById('animated-logo');
        const publicLabel = document.getElementById('public-label');
        const privateLabel = document.getElementById('private-label');
        const userInfoBtn = document.getElementById('user-info-btn');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        const logoutBtn = document.getElementById('logout-btn');
        const createBtn = document.getElementById('create-btn');
        const videoLinkInput = document.getElementById('videoLink');
        const linkStatusText = document.getElementById('link-status-text');
        const linkStatusIcon = document.querySelector('.link-status i');

        // ===== Current User & Room Data =====
        let currentUser = null;
        let currentRoomData = null;

        // ===== Authentication State Observer =====
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                setupAuthenticatedUser(user);
                loadPageContent();
            } else {
                // User is signed out, redirect to login
                showToast('Please log in to continue', true, 'warning');
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 1500);
            }
        });

        // ===== Setup Authenticated User =====
        function setupAuthenticatedUser(user) {
            userInfoBtn.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            
            // Set user display name and avatar
            const displayName = user.displayName || user.email || 'User';
            const email = user.email || '';
            
            // Extract first letter for avatar (prefer display name, fallback to email)
            const initial = displayName.charAt(0).toUpperCase();
            userAvatar.textContent = initial;
            
            // Display only email prefix (before @) if available
            let displayText = displayName;
            if (email && displayName === email) {
                const emailPrefix = email.split('@')[0];
                displayText = emailPrefix.charAt(0).toUpperCase() + emailPrefix.slice(1);
            }
            
            userName.textContent = displayText;
            
            // Add user info tooltip on hover
            userInfoBtn.title = `Logged in as ${displayName}`;
            
            // Add logout functionality
            logoutBtn.addEventListener('click', () => {
                logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging out...';
                logoutBtn.disabled = true;
                
                auth.signOut().then(() => {
                    showToast('Logged out successfully', false, 'success');
                    setTimeout(() => {
                        window.location.href = "index.html";
                    }, 1000);
                }).catch((error) => {
                    showToast('Error logging out: ' + error.message, true, 'error');
                    logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
                    logoutBtn.disabled = false;
                });
            });
        }

        // ===== Load Page Content =====
        function loadPageContent() {
            setTimeout(() => {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                    mainContainer.classList.remove('hidden');
                    mainContainer.classList.add('fade-in');
                    
                    // Set default time to 30 minutes from now
                    const now = new Date();
                    now.setMinutes(now.getMinutes() + 30);
                    const localDateTime = now.toISOString().slice(0, 16);
                    document.getElementById('startTime').value = localDateTime;
                    
                    // Start logo animation
                    startLogoAnimation();
                    
                    // Set up live link validation
                    setupLiveLinkValidation();
                    
                    // Load popular parties
                    loadPopularParties();
                    
                    // Set up auto-refresh for popular parties (every 3 minutes)
                    setInterval(loadPopularParties, 3 * 60 * 1000);
                    
                }, 500);
            }, 1000);
        }

        // ===== Animated Logo Functionality =====
        function startLogoAnimation() {
            const words = ['Connect', 'Watch', 'Stream', 'Share', 'Enjoy'];
            let currentIndex = 0;
            
            setInterval(() => {
                animatedLogo.style.opacity = '0';
                animatedLogo.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    currentIndex = (currentIndex + 1) % words.length;
                    animatedLogo.textContent = words[currentIndex];
                    animatedLogo.style.opacity = '1';
                    animatedLogo.style.transform = 'translateY(0)';
                }, 300);
            }, 3000);
        }

        // ===== Live Link Validation =====
        function setupLiveLinkValidation() {
            let validationTimeout;
            
            videoLinkInput.addEventListener('input', function() {
                const link = this.value.trim();
                
                // Clear previous timeout
                clearTimeout(validationTimeout);
                
                // Reset status
                linkStatusIcon.className = 'fas fa-circle status-processing';
                linkStatusText.textContent = 'Validating link...';
                
                // Debounce validation
                validationTimeout = setTimeout(async () => {
                    if (!link) {
                        linkStatusIcon.className = 'fas fa-circle status-processing';
                        linkStatusText.textContent = 'Enter a valid video link to generate watch party';
                        createBtn.disabled = false;
                        return;
                    }
                    
                    try {
                        const isValid = await validateVideoLink(link);
                        if (isValid) {
                            linkStatusIcon.className = 'fas fa-check-circle status-live';
                            linkStatusText.textContent = 'Link validated! Ready to create watch party';
                            createBtn.disabled = false;
                        } else {
                            linkStatusIcon.className = 'fas fa-exclamation-circle status-error';
                            linkStatusText.textContent = 'Invalid or unsupported video link';
                            createBtn.disabled = true;
                        }
                    } catch (error) {
                        linkStatusIcon.className = 'fas fa-exclamation-circle status-error';
                        linkStatusText.textContent = 'Error validating link';
                        createBtn.disabled = true;
                    }
                }, 800);
            });
        }

        // ===== Video Link Validation =====
        async function validateVideoLink(link) {
            if (!link || link.trim() === '') return false;
            
            const patterns = {
                youtube: /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/,
                vimeo: /^(https?:\/\/)?(www\.)?vimeo\.com\/.+$/,
                mp4: /^https?:\/\/.+\.mp4(\?.*)?$/,
                m3u8: /^https?:\/\/.+\.m3u8(\?.*)?$/,
                mpegDash: /^https?:\/\/.+\.mpd(\?.*)?$/,
                directVideo: /^https?:\/\/.+\.(mp4|webm|ogg|avi|mov|wmv|flv|mkv)(\?.*)?$/i
            };
            
            // Check against patterns
            for (const [platform, pattern] of Object.entries(patterns)) {
                if (pattern.test(link)) {
                    return true;
                }
            }
            
            // Check for YouTube video ID (11 characters)
            if (/^[A-Za-z0-9_-]{11}$/.test(link)) {
                return true;
            }
            
            // Additional validation could be done here (like HEAD request to check if URL exists)
            // For now, we'll accept any URL that looks like a video URL
            return link.startsWith('http') && 
                   (link.includes('video') || 
                    link.includes('stream') || 
                    link.includes('watch'));
        }

        // ===== Radio Button Selection =====
        publicLabel.addEventListener('click', () => {
            publicLabel.classList.add('selected');
            privateLabel.classList.remove('selected');
        });

        privateLabel.addEventListener('click', () => {
            privateLabel.classList.add('selected');
            publicLabel.classList.remove('selected');
        });

        // ===== Normalize Video Link =====
        function normalizeLink(raw) {
            if (!raw) return '';
            raw = raw.trim();
            
            // If it's just a YouTube video ID
            if (/^[A-Za-z0-9_-]{11}$/.test(raw)) {
                return `https://www.youtube.com/watch?v=${raw}`;
            }
            
            // Clean up YouTube URLs
            if (raw.includes('youtu.be/')) {
                const videoId = raw.split('youtu.be/')[1]?.split(/[?&#]/)[0];
                if (videoId) {
                    return `https://www.youtube.com/watch?v=${videoId}`;
                }
            }
            
            // Extract YouTube video ID from various URL formats
            const youtubeRegex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const youtubeMatch = raw.match(youtubeRegex);
            if (youtubeMatch) {
                return `https://www.youtube.com/watch?v=${youtubeMatch[1]}`;
            }
            
            return raw;
        }

        // ===== Generate Room Links =====
        function generateRoomLinks(roomId) {
            if (!roomId) return null;
            
            const baseUrl = window.location.origin;
            const currentPath = window.location.pathname.split('/').slice(0, -1).join('/') || '';
            const viewerPage = 'test.html'; // Your viewer page
            
            return {
                host: `${baseUrl}${currentPath}/${viewerPage}?room=${roomId}&host=true&uid=${currentUser.uid}`,
                viewer: `${baseUrl}${currentPath}/${viewerPage}?room=${roomId}`,
                roomId: roomId
            };
        }

        // ===== Create Room Function =====
        async function createRoom(uid, roomData) {
            return new Promise(async (resolve, reject) => {
                try {
                    const roomRef = db.ref('rooms').push();
                    const roomId = roomRef.key;
                    const startTimestamp = new Date(roomData.startTime).getTime();
                    
                    const roomObject = {
                        videoLink: roomData.videoLink,
                        scheduledStartTime: roomData.startTime,
                        startTimestamp: startTimestamp,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        createdBy: uid,
                        roomName: roomData.roomName || `Watch Party ${roomId.substring(0, 6)}`,
                        visibility: roomData.visibility,
                        status: 'scheduled',
                        currentTime: 0,
                        isLive: false,
                        meta: {
                            name: roomData.roomName || '',
                            type: 'video',
                            participants: 1,
                            hostName: currentUser.displayName || currentUser.email || 'Anonymous',
                            hostId: uid,
                            hostEmail: currentUser.email || '',
                            thumbnail: await generateThumbnail(roomData.videoLink),
                            platform: detectVideoPlatform(roomData.videoLink)
                        }
                    };
                    
                    await roomRef.set(roomObject);
                    
                    // Also create a reference in user's rooms
                    const userRoomRef = db.ref(`users/${uid}/rooms/${roomId}`);
                    await userRoomRef.set({
                        roomId: roomId,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        role: 'host'
                    });
                    
                    resolve(roomId);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // ===== Generate Thumbnail =====
        async function generateThumbnail(videoLink) {
            // This would normally call your thumbnail generation service
            // For now, return a placeholder based on video platform
            if (videoLink.includes('youtube')) {
                const videoId = extractYouTubeId(videoLink);
                if (videoId) {
                    return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
                }
            }
            
            // Generate a gradient based on the link
            const colors = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #6A0DFF 0%, #D300FF 100%)'
            ];
            
            const hash = videoLink.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            return colors[hash % colors.length];
        }

        // ===== Extract YouTube ID =====
        function extractYouTubeId(url) {
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[7].length === 11) ? match[7] : false;
        }

        // ===== Detect Video Platform =====
        function detectVideoPlatform(link) {
            if (link.includes('youtube')) return 'youtube';
            if (link.includes('vimeo')) return 'vimeo';
            if (link.includes('.mp4')) return 'mp4';
            if (link.includes('.m3u8')) return 'hls';
            if (link.includes('.mpd')) return 'dash';
            return 'direct';
        }

        // ===== Form Submission =====
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Check if user is authenticated
            if (!currentUser) {
                showToast('Please log in to create a room', true, 'error');
                window.location.href = "index.html";
                return;
            }
            
            const raw = videoLinkInput.value.trim();
            const videoLink = normalizeLink(raw);
            const startTime = document.getElementById('startTime').value;
            const roomName = document.getElementById('roomName').value.trim();
            const visibility = document.querySelector('input[name="visibility"]:checked').value;

            // Validate inputs
            if (!videoLink || !startTime) {
                showToast('Please provide video link and start time', true, 'error');
                videoLinkInput.focus();
                return;
            }
            
            // Validate video link
            const isValid = await validateVideoLink(videoLink);
            if (!isValid) {
                showToast('Please enter a valid video link', true, 'error');
                videoLinkInput.focus();
                videoLinkInput.classList.add('shake');
                setTimeout(() => videoLinkInput.classList.remove('shake'), 500);
                return;
            }

            try {
                // Update button state
                const originalContent = createBtn.innerHTML;
                createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Watch Party...';
                createBtn.disabled = true;

                const roomData = {
                    videoLink,
                    startTime,
                    roomName,
                    visibility
                };

                // Create the room
                const roomId = await createRoom(currentUser.uid, roomData);

                // Generate and display links
                const links = generateRoomLinks(roomId);
                
                if (!links) {
                    throw new Error('Failed to generate room links');
                }

                showToast('Watch party created successfully!', false, 'success');
                
                // Show output section with animation
                outputSection.classList.remove('hidden');
                outputSection.classList.add('slide-in-right');
                
                // Set link values
                document.getElementById('host-link').value = links.host;
                document.getElementById('viewer-link').value = links.viewer;
                document.getElementById('room-id').value = links.roomId;

                // Clear form (except visibility)
                videoLinkInput.value = '';
                document.getElementById('roomName').value = '';
                
                // Set next default time (1 hour from now)
                const now = new Date();
                now.setHours(now.getHours() + 1);
                document.getElementById('startTime').value = now.toISOString().slice(0, 16);

                // Scroll to output section
                setTimeout(() => {
                    outputSection.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);

                // Reload popular parties to include new one
                setTimeout(loadPopularParties, 1000);

            } catch (error) {
                console.error('Error creating room:', error);
                showToast('Error creating room: ' + error.message, true, 'error');
            } finally {
                // Reset button state
                createBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Create Watch Party';
                createBtn.disabled = false;
            }
        });

        // ===== Load Popular Parties =====
        async function loadPopularParties() {
            try {
                refreshPartiesBtn.classList.add('spinning');
                
                const snapshot = await db.ref('rooms')
                    .orderByChild('status')
                    .equalTo('live')
                    .once('value');

                const parties = [];
                snapshot.forEach((childSnapshot) => {
                    const party = childSnapshot.val();
                    party.id = childSnapshot.key;
                    
                    // Only include public parties
                    if (party.visibility === 'public' && party.isLive !== false) {
                        parties.push(party);
                    }
                });

                // Sort by participants count (descending) and recency
                parties.sort((a, b) => {
                    const aCount = a.meta?.participants || 0;
                    const bCount = b.meta?.participants || 0;
                    const aTime = a.startTimestamp || 0;
                    const bTime = b.startTimestamp || 0;
                    
                    // Prioritize live parties with more participants
                    if (aCount !== bCount) return bCount - aCount;
                    return bTime - aTime;
                });

                // Take top 3
                const topParties = parties.slice(0, 3);
                renderPopularParties(topParties);

            } catch (error) {
                console.error('Error loading popular parties:', error);
                showToast('Error loading popular parties', true, 'error');
            } finally {
                refreshPartiesBtn.classList.remove('spinning');
            }
        }

        // ===== Render Popular Parties =====
        function renderPopularParties(parties) {
            popularPartiesList.innerHTML = '';

            if (parties.length === 0) {
                popularPartiesList.innerHTML = `
                    <div class="no-parties">
                        <i class="fas fa-film"></i>
                        <h3>No Live Parties Yet</h3>
                        <p>Be the first to create a public watch party and get featured here!</p>
                    </div>
                `;
                return;
            }

            parties.forEach((party, index) => {
                const isYouTube = party.videoLink && party.videoLink.includes('youtube');
                const timeText = party.status === 'live' ? 'Live Now' : 'Starting Soon';
                const viewerCount = party.meta?.participants || 1;
                const hostName = party.meta?.hostName || 'Anonymous';
                const roomName = party.roomName || party.meta?.name || `Party ${party.id.substring(0, 6)}`;
                const thumbnail = party.meta?.thumbnail || getThumbnailStyle(party);
                
                const partyElement = document.createElement('div');
                partyElement.className = 'party-item';
                partyElement.innerHTML = `
                    <div class="party-thumbnail">
                        <div class="popular-badge">
                            <i class="fas fa-fire"></i> #${index + 1} Trending
                        </div>
                        ${typeof thumbnail === 'string' && thumbnail.includes('linear-gradient') 
                            ? `<div style="width: 100%; height: 100%; background: ${thumbnail}; display: flex; align-items: center; justify-content: center; color: white; font-size: 36px;">
                                <i class="${isYouTube ? 'fab fa-youtube' : 'fas fa-film'}"></i>
                               </div>`
                            : `<img src="${thumbnail}" alt="${roomName}" onerror="this.onerror=null; this.parentElement.innerHTML='<div style=\\'width: 100%; height: 100%; background: linear-gradient(135deg, #6A0DFF 0%, #D300FF 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 36px;\\'><i class=\\'${isYouTube ? 'fab fa-youtube' : 'fas fa-film'}\\'></i></div>'">`
                        }
                    </div>
                    <div class="party-info">
                        <div>
                            <div class="party-name">${roomName}</div>
                            <div class="party-host">
                                <i class="fas fa-user"></i> Hosted by ${hostName}
                            </div>
                        </div>
                        <div class="party-meta">
                            <span><i class="fas fa-users"></i> <span class="viewer-count">${viewerCount}</span> ${viewerCount === 1 ? 'viewer' : 'viewers'}</span>
                            <span><i class="fas fa-clock"></i> ${timeText}</span>
                        </div>
                        <button class="join-btn-small" onclick="joinParty('${party.id}')">
                            <i class="fas fa-play"></i>
                            Join Now
                        </button>
                    </div>
                `;
                popularPartiesList.appendChild(partyElement);
            });
        }

        // ===== Refresh Parties =====
        refreshPartiesBtn.addEventListener('click', () => {
            refreshPartiesBtn.classList.add('spinning');
            loadPopularParties();
            
            // Add haptic feedback if available
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        });

        // ===== Utility Functions =====
        function copyLink(elementId) {
            const el = document.getElementById(elementId);
            el.select();
            el.setSelectionRange(0, 99999);
            
            try {
                navigator.clipboard.writeText(el.value).then(() => {
                    showToast('Link copied to clipboard!', false, 'success');
                    
                    // Add haptic feedback if available
                    if (navigator.vibrate) {
                        navigator.vibrate(100);
                    }
                }).catch(() => {
                    // Fallback for older browsers
                    document.execCommand('copy');
                    showToast('Link copied to clipboard!', false, 'success');
                });
            } catch (err) {
                // Final fallback
                document.execCommand('copy');
                showToast('Link copied to clipboard!', false, 'success');
            }
        }

        function joinParty(roomId) {
            showToast('Joining watch party...', false, 'warning');
            
            // Check if room exists
            db.ref(`rooms/${roomId}`).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    
                    // Check if room is live or scheduled
                    if (roomData.status === 'live' || roomData.status === 'scheduled') {
                        // Generate viewer link
                        const links = generateRoomLinks(roomId);
                        if (links && links.viewer) {
                            // Redirect to viewer page
                            setTimeout(() => {
                                window.location.href = links.viewer;
                            }, 500);
                        } else {
                            showToast('Error generating join link', true, 'error');
                        }
                    } else {
                        showToast('This party is not currently available', true, 'error');
                    }
                } else {
                    showToast('Party not found', true, 'error');
                }
            }).catch((error) => {
                showToast('Error joining party: ' + error.message, true, 'error');
            });
        }

        function showToast(message, isError = false, type = 'info') {
            // Remove existing toast classes
            toast.className = 'toast';
            
            // Set appropriate class based on type
            if (type === 'success') {
                toast.classList.add('success');
                toast.querySelector('i').className = 'fas fa-check-circle';
            } else if (type === 'error') {
                toast.classList.add('error');
                toast.querySelector('i').className = 'fas fa-exclamation-circle';
            } else if (type === 'warning') {
                toast.classList.add('warning');
                toast.querySelector('i').className = 'fas fa-exclamation-triangle';
            } else {
                toast.querySelector('i').className = 'fas fa-info-circle';
            }
            
            toastMessage.textContent = message;
            
            // Show toast
            toast.classList.add('show');
            
            // Auto-hide after delay
            setTimeout(() => {
                toast.classList.remove('show');
            }, type === 'error' ? 5000 : 3000);
        }

        function getThumbnailStyle(party) {
            const colors = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #6A0DFF 0%, #D300FF 100%)'
            ];
            
            if (party.id) {
                const hash = party.id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                return colors[hash % colors.length];
            }
            
            return colors[0];
        }

        // ===== Keyboard Shortcuts =====
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter to submit form
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && createForm.checkValidity()) {
                createForm.dispatchEvent(new Event('submit'));
            }
            
            // Escape to hide toast
            if (e.key === 'Escape' && toast.classList.contains('show')) {
                toast.classList.remove('show');
            }
        });

        // ===== Page Visibility API =====
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                // Page became visible, refresh parties
                loadPopularParties();
            }
        });

        // ===== Service Worker Registration (Progressive Web App) =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(error => {
                    console.log('ServiceWorker registration failed:', error);
                });
            });
        }

        // ===== Performance Monitoring =====
        window.addEventListener('load', () => {
            // Log page load performance
            if (window.performance) {
                const perfData = window.performance.timing;
                const loadTime = perfData.loadEventEnd - perfData.navigationStart;
                console.log(`Page loaded in ${loadTime}ms`);
            }
        });
    </script>
</body>
</html>
