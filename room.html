<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Watch Party Room</title>
  <style>
    #player-container {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%;
      margin: 20px 0;
    }
    #player {
      position: absolute;
      width: 100%;
      height: 100%;
    }
    #controls { margin: 20px 0; }
  </style>
</head>
<body>
  <h2>Watch Party Room</h2>
  <div id="player-container">
    <div id="player"></div>
  </div>
  <div id="controls" style="display: none;">
    <button onclick="playVideo()">▶ Play</button>
    <button onclick="pauseVideo()">⏸ Pause</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="firebase-config.js"></script>

  <script>
    let player, syncInterval, roomRef;
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');
    const isHost = urlParams.get('host') === 'true';

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Initialize YouTube Player
    function onYouTubeIframeAPIReady() {
      roomRef = db.ref(`rooms/${roomId}`);
      
      roomRef.on('value', snapshot => {
        if (!snapshot.exists()) {
          document.body.innerHTML = '<h3>Room not found or expired</h3>';
          return;
        }

        const data = snapshot.val();
        initializePlayer(data);
      });

      // Room cleanup after 1 hour of inactivity
      roomRef.child('lastActive').onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
      roomRef.update({ lastActive: firebase.database.ServerValue.TIMESTAMP });
    }

    function initializePlayer(data) {
      if (!player) {
        player = new YT.Player('player', {
          height: '100%',
          width: '100%',
          videoId: data.videoId,
          playerVars: {
            'autoplay': isHost ? 1 : 0,
            'controls': 1,
            'rel': 0,
            'enablejsapi': 1
          },
          events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          }
        });
      }
    }

    function onPlayerReady(event) {
      if (isHost) {
        document.getElementById('controls').style.display = 'block';
        syncInterval = setInterval(updateHostTime, 1000);
        event.target.playVideo();
      } else {
        syncInterval = setInterval(syncViewerTime, 1000);
        roomRef.child('currentTime').once('value', snap => {
          event.target.seekTo(snap.val(), true);
        });
      }
    }

    function onPlayerStateChange(event) {
      if (isHost) {
        roomRef.update({ 
          status: event.data === YT.PlayerState.PLAYING ? 'play' : 'pause'
        });
      }
    }

    function updateHostTime() {
      roomRef.update({ 
        currentTime: player.getCurrentTime(),
        lastActive: firebase.database.ServerValue.TIMESTAMP
      });
    }

    function syncViewerTime() {
      roomRef.child('currentTime').once('value', snap => {
        const serverTime = snap.val();
        const diff = Math.abs(player.getCurrentTime() - serverTime);
        if (diff > 1) player.seekTo(serverTime, true);
      });
    }

    function playVideo() { if (isHost) player.playVideo(); }
    function pauseVideo() { if (isHost) player.pauseVideo(); }

    // Cleanup
    window.addEventListener('beforeunload', () => {
      clearInterval(syncInterval);
      if (isHost) {
        roomRef.update({ 
          status: 'pause',
          lastActive: firebase.database.ServerValue.TIMESTAMP
        });
      }
    });
  </script>
</body>
</html>
