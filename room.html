<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Watch Room</title>
  <style>
    #player { width: 640px; height: 360px; }
    #controls { margin-top: 10px; }
  </style>
</head>
<body>
  <h2>Watch Party Room</h2>
  <div id="player"></div>
  <div id="controls" style="display:none;">
    <button onclick="playVideo()">▶️ Play</button>
    <button onclick="pauseVideo()">⏸️ Pause</button>
  </div>

  <!-- Dependencies -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="firebase-config.js"></script>

  <script>
    let player, syncInterval;
    const urlParams = new URLSearchParams(window.location.search);
    const roomId = urlParams.get('room');
    const isHost = urlParams.get('host') === 'true';
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const roomRef = db.ref(`rooms/${roomId}`);

    // Initialize YouTube Player
    function onYouTubeIframeAPIReady() {
      roomRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          document.body.innerHTML = '<h3>Room not found!</h3>';
          return;
        }

        const data = snapshot.val();
        const videoId = extractVideoId(data.videoLink);
        
        player = new YT.Player('player', {
          height: '360',
          width: '640',
          videoId: videoId || 'dQw4w9WgXcQ', // Fallback video
          events: {
            onReady: initPlayer,
            onStateChange: syncPlayerState
          }
        });
      });
    }

    function initPlayer() {
      if (isHost) {
        document.getElementById('controls').style.display = 'block';
        syncInterval = setInterval(updateHostTime, 1000);
      } else {
        syncInterval = setInterval(syncViewerTime, 1000);
      }
      
      roomRef.child('status').on('value', snap => {
        const status = snap.val();
        if (status === 'play') player.playVideo();
        if (status === 'pause') player.pauseVideo();
      });
    }

    function updateHostTime() {
      roomRef.update({ currentTime: player.getCurrentTime() });
    }

    function syncViewerTime() {
      roomRef.child('currentTime').once('value').then(snap => {
        const serverTime = snap.val();
        if (Math.abs(player.getCurrentTime() - serverTime) > 1) {
          player.seekTo(serverTime, true);
        }
      });
    }

    function playVideo() { if (isHost) { player.playVideo(); roomRef.update({ status: 'play' }); } }
    function pauseVideo() { if (isHost) { player.pauseVideo(); roomRef.update({ status: 'pause' }); } }

    function extractVideoId(url) {
      const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
      const match = url.match(regExp);
      return (match && match[2].length === 11) ? match[2] : null;
    }

    // Cleanup
    window.addEventListener('beforeunload', () => {
      clearInterval(syncInterval);
      if (isHost) roomRef.remove();
      roomRef.off();
    });
  </script>
</body>
</html>
