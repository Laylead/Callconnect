<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Party Room</title>
<style>
  body, html { margin:0; padding:0; height:100%; font-family:Arial, sans-serif; background:#f6f8fb; }
  #container { display:flex; flex-direction:row; height:100%; }
  @media(max-width:768px){ #container{ flex-direction:column; } }

  /* Video Section */
  #player-section { flex:2; position:relative; display:flex; flex-direction:column; background:black; }
  #video { width:100%; height:100%; background:black; object-fit:contain; }
  #overlay-block { position:absolute; top:0; left:0; right:0; bottom:0; z-index:50; display:none; cursor:not-allowed; }
  #drawingCanvas { position:absolute; left:0; top:0; width:100%; height:100%; z-index:60; pointer-events:none; }
  #reactions { position:absolute; top:12px; right:12px; display:flex; flex-direction:column; gap:6px; z-index:70; }

  /* Sidebar */
  #sidebar { flex:1; display:flex; flex-direction:column; padding:8px; background:#fff; overflow-y:auto; }
  @media(max-width:768px){ #sidebar{ flex:none; height:40%; } }

  .btn { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#2b6cdf; color:#fff; }
  .btn.grey { background:#666; }

  #controls { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px; }
  #chat { flex:1; display:flex; flex-direction:column; border-top:1px solid #ccc; margin-top:6px; }
  #messages { flex:1; overflow-y:auto; padding:6px; border-bottom:1px solid #ccc; }
  #messages div { margin-bottom:4px; }
  #chatInput { display:flex; gap:4px; margin-top:4px; }
  #chatInput input { flex:1; padding:4px; }
  #chatInput button { flex:0; }
  #status { margin-top:4px; font-weight:600; font-size:13px; }
</style>
</head>
<body>
<div id="container">
  <div id="player-section">
    <video id="video" controls crossorigin playsinline></video>
    <div id="overlay-block"></div>
    <canvas id="drawingCanvas"></canvas>
    <div id="reactions"></div>

    <div id="controls">
      <button id="pauseDiscussBtn" class="btn grey">Pause & Discuss</button>
      <button id="toggleDrawBtn" class="btn grey">Draw</button>
      <button id="spotlightBtn" class="btn grey">Spotlight</button>
      <button id="focusBtn" class="btn grey">Focus</button>
      <button id="micBtn" class="btn">Talk</button>
      <label>Speed:
        <select id="speedSel">
          <option value="0.5">0.5x</option>
          <option value="0.75">0.75x</option>
          <option value="1" selected>1x</option>
          <option value="1.25">1.25x</option>
          <option value="1.5">1.5x</option>
        </select>
      </label>
    </div>
    <div id="status">Loading...</div>
  </div>

  <div id="sidebar">
    <div id="predict-panel"></div>
    <div id="poll-panel"></div>
    <div id="chat">
      <div id="messages"></div>
      <div id="chatInput">
        <input id="chatMsg" placeholder="Type message"/>
        <button id="sendMsgBtn" class="btn">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="firebase-config.js"></script>

<!-- Agora -->
<script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.9.0.js"></script>
<script src="agora.js"></script>

<script>
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();
auth.signInAnonymously().catch(console.warn);

// URL params
const params = new URLSearchParams(window.location.search);
const roomId = params.get('room');
const isHost = params.get('host')==='true';
const roomRef = db.ref('rooms/'+roomId);
const drawRef = db.ref('rooms/'+roomId+'/drawing');
const reactionsRef = db.ref('rooms/'+roomId+'/reactions');
const chatRef = db.ref('rooms/'+roomId+'/chat');

// Elements
const video=document.getElementById('video');
const overlay=document.getElementById('overlay-block');
const canvas=document.getElementById('drawingCanvas');
const ctx=canvas.getContext('2d');
const messagesDiv=document.getElementById('messages');
const micBtn=document.getElementById('micBtn');
const status=document.getElementById('status');

let ready=false, drawerEnabled=false, drawing=false, lastPos=null, discussionMode=false;

// Fit canvas
function fitCanvas(){canvas.width=video.clientWidth; canvas.height=video.clientHeight;}
window.addEventListener('resize', fitCanvas);

// Load video link
roomRef.once('value').then(snap=>{
  const data=snap.val();
  if(!data){alert('Room not found'); return;}
  const link = data.videoLink;
  if(link.includes('youtube.com') || link.includes('youtu.be')){
    // Auto embed youtube
    const id = link.split('v=')[1] || link.split('youtu.be/')[1];
    video.src = `https://www.youtube.com/embed/${id}?enablejsapi=1`;
  } else {
    video.src=link;
  }
  fitCanvas();
  setupParty();
});

function setupParty(){
  video.addEventListener('loadedmetadata', ()=>{
    ready=true;
    if(isHost) setupHost();
    else setupViewer();
  });
}

// HOST
function setupHost(){
  status.textContent='Host mode';
  function pushState(st){roomRef.update({status:st,currentTime:video.currentTime, hostPowers:{speed:Number(document.getElementById('speedSel').value)}});}
  video.addEventListener('play', ()=>{overlay.style.display='none'; pushState('play'); roomRef.update({discussionOpen:false});});
  video.addEventListener('pause', ()=>{pushState('pause');});
  video.addEventListener('seeked', ()=>{pushState(video.paused?'pause':'play');});

  setInterval(()=>{if(!ready || video.paused) return; roomRef.update({currentTime:video.currentTime});},500);

  document.getElementById('pauseDiscussBtn').addEventListener('click', ()=>{
    video.pause();
    roomRef.update({status:'pause', discussionOpen:true});
  });

  document.getElementById('toggleDrawBtn').addEventListener('click', ()=>{
    drawerEnabled=!drawerEnabled;
    document.getElementById('toggleDrawBtn').textContent=drawerEnabled?'Drawing ON':'Draw';
    roomRef.update({drawingEnabled:drawerEnabled});
  });

  document.getElementById('speedSel').addEventListener('change', e=>{
    const sp=Number(e.target.value||1);
    video.playbackRate=sp;
    roomRef.update({hostPowers:{speed:sp}});
  });
}

// VIEWER
function setupViewer(){
  status.textContent='Viewer mode';
  roomRef.on('value', snap=>{
    const data=snap.val();
    if(!ready || !data) return;
    discussionMode=!!data.discussionOpen;
    const diff=(data.currentTime||0)-video.currentTime;
    if(Math.abs(diff)>1.5) video.currentTime=data.currentTime;
    else if(Math.abs(diff)>0.05) video.currentTime+=diff*0.2;
    if(data.status==='play' && video.paused) video.play().catch(()=>{});
    else if(data.status==='pause' && !discussionMode) video.pause();
    if(data.drawingEnabled) enableDrawing(); else disableDrawing();
  });
}

// DRAWING
function enableDrawing(){canvas.style.pointerEvents='auto'; canvas.addEventListener('mousedown',onDown); canvas.addEventListener('mousemove',onMove); canvas.addEventListener('mouseup',onUp);}
function disableDrawing(){canvas.style.pointerEvents='none'; canvas.removeEventListener('mousedown',onDown); canvas.removeEventListener('mousemove',onMove); canvas.removeEventListener('mouseup',onUp);}
function onDown(e){drawing=true; const r=canvas.getBoundingClientRect(); lastPos={x:e.clientX-r.left, y:e.clientY-r.top};}
function onMove(e){if(!drawing) return; const r=canvas.getBoundingClientRect(); const x=e.clientX-r.left, y=e.clientY-r.top; ctx.strokeStyle='#ff0'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(lastPos.x,lastPos.y); ctx.lineTo(x,y); ctx.stroke(); drawRef.push({lx:lastPos.x/canvas.width, ly:lastPos.y/canvas.height, x:x/canvas.width, y:y/canvas.height, color:'#ff0', thickness:3}); lastPos={x,y};}
function onUp(){drawing=false; lastPos=null;}

// CHAT
document.getElementById('sendMsgBtn').addEventListener('click', ()=>{
  const txt=document.getElementById('chatMsg').value.trim();
  if(!txt) return;
  chatRef.push({text:txt, uid:auth.currentUser.uid, ts:firebase.database.ServerValue.TIMESTAMP});
  document.getElementById('chatMsg').value='';
});

chatRef.on('child_added', snap=>{
  const m=snap.val();
  const div=document.createElement('div'); div.textContent=m.text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
});

// REACTIONS
const quickEmojis=['ðŸ˜‚','ðŸ˜±','ðŸ¤¨','ðŸ‘'];
quickEmojis.forEach(e=>{const b=document.createElement('button'); b.textContent=e; b.className='btn grey'; b.onclick=()=>reactionsRef.push({emoji:e, at:firebase.database.ServerValue.TIMESTAMP}); document.body.appendChild(b);});

// Agora voice
auth.onAuthStateChanged(user=>{if(user) initAgoraVoice(firebase,auth,roomId,isHost);});

fitCanvas();
</script>
</body>
</html>
