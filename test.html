<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Watch Party ‚Äî Smooth Pro</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    :root{--accent:#2b6cdf;--muted:#666}
    body{margin:0;font-family:Inter,Arial,sans-serif;background:#0b1220;color:#fff;display:flex;flex-direction:column;align-items:center;padding:12px}
    .wrap{width:100%;max-width:1300px;display:flex;gap:16px}
    #left{flex:1;display:flex;flex-direction:column;gap:10px}
    #playerContainer{position:relative;background:#000;border-radius:8px;overflow:hidden}
    #player, #html5video{width:100%;height:calc(100vw*9/16);max-height:720px;background:#000}
    #html5video{display:none}
    #canvas{position:absolute;left:0;top:0;z-index:40;pointer-events:none}
    #overlay{position:absolute;left:0;top:0;right:0;bottom:0;z-index:45;display:none;cursor:not-allowed}
    #playPrompt{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);z-index:60;display:none;background:rgba(0,0,0,0.6);padding:12px;border-radius:8px}
    #right{width:360px;min-width:260px;background:rgba(255,255,255,0.03);padding:12px;border-radius:8px}
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.grey{background:var(--muted)}
    .small{font-size:13px;color:#cbd5e1}
    .control-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    #agora-controls{margin-left:auto}
    .reaction{background:rgba(255,255,255,0.95);color:#000;padding:6px 8px;border-radius:20px;display:inline-block;margin-right:6px}
    #status{margin-top:10px;color:#cbd5e1}
    @media (max-width:900px){ .wrap{flex-direction:column} #right{width:100%} #player, #html5video{height:56vw} }
  </style>
</head>
<body>
  <div style="width:100%;max-width:1300px;display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <div><strong>Watch Party ‚Äî Smooth Pro</strong></div>
    <div id="agora-controls"></div>
  </div>

  <div class="wrap">
    <div id="left">
      <div id="playerContainer">
        <div id="player"></div>
        <video id="html5video" controls crossorigin playsinline></video>
        <canvas id="canvas"></canvas>
        <div id="overlay"></div>
        <div id="playPrompt"><div style="margin-bottom:8px">Tap to enable audio</div><button id="enablePlay" class="btn">Enable & Play</button></div>
      </div>

      <div class="control-row" style="margin-top:8px">
        <button id="pauseDiscuss" class="btn grey">Pause & Discuss</button>
        <button id="drawBtn" class="btn grey">Draw</button>
        <button id="clearBtn" class="btn grey">Clear Drawing</button>
        <button id="focusBtn" class="btn grey">Focus (mute)</button>
        <label class="small" style="margin-left:8px">Speed:
          <select id="speedSel" style="margin-left:6px;padding:6px;border-radius:6px">
            <option value="0.5">0.5x</option><option value="0.75">0.75x</option><option value="1" selected>1x</option><option value="1.25">1.25x</option><option value="1.5">1.5x</option>
          </select>
        </label>
        <button id="fullscreen" class="btn" style="margin-left:auto">Fullscreen</button>
      </div>

      <div id="status" class="small">Loading room...</div>
    </div>

    <div id="right">
      <div><strong>Room Controls & Extras</strong></div>
      <div style="margin-top:8px">
        <button id="predict" class="btn grey">Play & Predict</button>
        <button id="poll" class="btn grey">Quick Poll</button>
      </div>

      <div style="margin-top:12px"><strong>Quick Reactions</strong></div>
      <div style="margin-top:8px">
        <button class="btn grey" data-emoji="üòÇ">üòÇ</button>
        <button class="btn grey" data-emoji="üò±">üò±</button>
        <button class="btn grey" data-emoji="ü§®">ü§®</button>
        <button class="btn grey" data-emoji="üëè">üëè</button>
      </div>

      <div style="margin-top:12px">
        <strong>Predictions</strong>
        <div id="predictPanel"></div>
      </div>

      <div style="margin-top:12px">
        <strong>Polls</strong>
        <div id="pollPanel"></div>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- YouTube IFrame -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <!-- Agora -->
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.9.0.js"></script>
  <script src="agora.js"></script>

  <script>
  // ---------- init ----------
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();
  auth.signInAnonymously().catch(()=>{});

  const url = new URL(location.href);
  const params = new URLSearchParams(url.search);
  const roomId = params.get('room');
  const isHost = params.get('host') === 'true';

  // DB refs
  const roomRef = db.ref('rooms/' + roomId);
  const drawRef = db.ref('rooms/' + roomId + '/drawing');
  const reactionsRef = db.ref('rooms/' + roomId + '/reactions');
  const predictsRef = db.ref('rooms/' + roomId + '/predicts');
  const pollsRef = db.ref('rooms/' + roomId + '/polls');

  // DOM
  const playerDiv = document.getElementById('player');
  const html5video = document.getElementById('html5video');
  const overlay = document.getElementById('overlay');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const playPrompt = document.getElementById('playPrompt');
  const enablePlay = document.getElementById('enablePlay');
  const statusEl = document.getElementById('status');

  const fullscreenBtn = document.getElementById('fullscreen');

  // buttons
  const pauseDiscussBtn = document.getElementById('pauseDiscuss');
  const drawBtn = document.getElementById('drawBtn');
  const clearBtn = document.getElementById('clearBtn');
  const focusBtn = document.getElementById('focusBtn');
  const speedSel = document.getElementById('speedSel');
  const predictBtn = document.getElementById('predict');
  const pollBtn = document.getElementById('poll');
  const reactionButtons = Array.from(document.querySelectorAll('#right button[data-emoji]'));

  // agora mic hold (will map to agora.js startWhisper/stopWhisper)
  // agora.js will create a mic button in #agora-controls; but we expose a hold UI here:
  let holdMicBtn = null;

  // player state
  let usingYouTube = false;
  let ytPlayer = null;
  let ready = false;
  let drawerOn = false;
  let drawing = false;
  let lastPos = null;

  // jitter compensation state
  let lastServerUpdatedAt = 0;
  let lastReceiveLocalTs = 0;
  let bufferingCount = 0;

  // helpers
  function isYouTube(url){ return /youtube\.com|youtu\.be|youtube-nocookie\.com/.test(url); }
  function extractYTId(url){ const reg=/^.*(?:v=|v\/|embed\/|youtu\.be\/)([^#&?]*).*/; const m=url.match(reg); return (m && m[1] && m[1].length===11)?m[1]:null; }

  // unified player API
  function pPlay(){ if(usingYouTube){ if(ytPlayer) ytPlayer.playVideo(); } else html5video.play().catch(()=>{}); }
  function pPause(){ if(usingYouTube){ if(ytPlayer) ytPlayer.pauseVideo(); } else html5video.pause(); }
  function pGetTime(){ if(usingYouTube) return ytPlayer? ytPlayer.getCurrentTime() : 0; return html5video.currentTime || 0; }
  function pSeek(t){ if(usingYouTube){ if(ytPlayer) ytPlayer.seekTo(t, true); } else html5video.currentTime = t; }
  function pSetRate(r){ if(usingYouTube){ if(ytPlayer) ytPlayer.setPlaybackRate(r); } else html5video.playbackRate = r; }
  function pIsPlaying(){ if(usingYouTube) return ytPlayer && ytPlayer.getPlayerState() === YT.PlayerState.PLAYING; return !html5video.paused; }

  // load room
  roomRef.once('value').then(snap=>{
    const data = snap.val();
    if(!data){ alert('Room not found'); return; }
    statusEl.textContent = isHost ? 'You are host' : 'Viewer ‚Äî waiting';
    const link = data.videoLink;
    if(isYouTube(link)){
      usingYouTube = true;
      const vid = extractYTId(link) || link;
      initYT(vid);
    } else {
      usingYouTube = false;
      playerDiv.style.display = 'none';
      html5video.style.display = 'block';
      html5video.src = link;
    }

    fitCanvas();
    window.addEventListener('resize', fitCanvas);

    // init agora when auth ready
    auth.onAuthStateChanged(user => { if(user){ window.__WP_roomId = roomId; initAgoraVoice(firebase, auth, roomId, isHost); } });

    // wire flows
    prepareFlow();
  }).catch(err=>{ console.error(err); statusEl.textContent = 'Error loading room'; });

  // YT init
  function initYT(videoId){
    ytPlayer = new YT.Player('player', {
      height:'100%',
      width:'100%',
      videoId,
      playerVars:{rel:0,modestbranding:1},
      events:{
        onReady: ()=>{ ready = true; },
        onStateChange: e => { if(isHost) handleHostYTState(e); if(!isHost) {/* viewer handled via DB */} }
      }
    });
  }
  function handleHostYTState(e){
    if(e.data === YT.PlayerState.PLAYING){
      roomRef.update({ status:'play', currentTime: ytPlayer.getCurrentTime(), updatedAt: firebase.database.ServerValue.TIMESTAMP });
    } else if(e.data === YT.PlayerState.PAUSED){
      roomRef.update({ status:'pause', currentTime: ytPlayer.getCurrentTime(), updatedAt: firebase.database.ServerValue.TIMESTAMP });
    }
  }

  // HTML5 host events
  function wireHtmlHost(){
    html5video.addEventListener('play', ()=> roomRef.update({ status:'play', currentTime: html5video.currentTime, updatedAt: firebase.database.ServerValue.TIMESTAMP }));
    html5video.addEventListener('pause', ()=> roomRef.update({ status:'pause', currentTime: html5video.currentTime, updatedAt: firebase.database.ServerValue.TIMESTAMP }));
    html5video.addEventListener('seeked', ()=> roomRef.update({ status: html5video.paused ? 'pause' : 'play', currentTime: html5video.currentTime, updatedAt: firebase.database.ServerValue.TIMESTAMP }));
    // buffering detection
    html5video.addEventListener('waiting', () => onBufferingEvent());
    html5video.addEventListener('stalled', () => onBufferingEvent());
  }

  // buffering handling
  function onBufferingEvent(){
    bufferingCount++;
    if(bufferingCount >= 3){
      console.warn('Detected repeated buffering -> attempting recovery');
      bufferingCount = 0;
      tryRecoverPlayback();
    }
    // clear after a bit
    setTimeout(()=> bufferingCount = Math.max(0, bufferingCount - 1), 4000);
  }

  function tryRecoverPlayback(){
    // strategy: reload source and seek to hostEffectiveTime
    roomRef.once('value').then(s=>{
      const d = s.val() || {};
      const hostTime = d.currentTime || 0;
      if(usingYouTube){
        try{
          if(ytPlayer){
            ytPlayer.stopVideo();
            ytPlayer.loadVideoById({ videoId: extractYTId(d.videoLink) || d.videoLink, startSeconds: Math.max(0, hostTime - 0.5) });
            roomRef.update({ updatedAt: firebase.database.ServerValue.TIMESTAMP });
          }
        }catch(e){ console.warn('YT recovery failed', e); }
      } else {
        try{
          const src = html5video.src;
          html5video.pause();
          // reload with cache-bust
          html5video.src = src.split('?')[0] + '?cb=' + Date.now();
          html5video.load();
          html5video.currentTime = Math.max(0, hostTime - 0.5);
          html5video.play().catch(()=>{ showPlayPrompt(); });
        }catch(e){ console.warn('HTML5 recover fail', e); }
      }
    });
  }

  // prepare flow for host/viewer
  function prepareFlow(){
    if(isHost){
      if(!usingYouTube) wireHtmlHost();
      // host periodic updates
      setInterval(()=>{
        try{
          if(pIsPlayingCustom()){
            const ct = pGetTime();
            roomRef.update({ currentTime: ct, updatedAt: firebase.database.ServerValue.TIMESTAMP });
          }
        }catch(e){}
      }, 700);
      setupHostUI();
    } else {
      setupViewerSync();
    }

    // drawing listener
    drawRef.on('child_added', snap => {
      const s = snap.val();
      if(!s) return;
      ctx.strokeStyle = s.color || '#ff0';
      ctx.lineWidth = s.thickness || 3;
      ctx.beginPath();
      ctx.moveTo(s.lx * canvas.width, s.ly * canvas.height);
      ctx.lineTo(s.x * canvas.width, s.y * canvas.height);
      ctx.stroke();
    });

    // clearDrawing flag
    roomRef.child('clearDrawing').on('value', snap => {
      if(snap.val()){
        clearCanvas();
        roomRef.child('clearDrawing').remove().catch(()=>{});
      }
    });

    // reactions
    reactionsRef.on('child_added', snap => { const v = snap.val(); if(v && v.emoji) showReaction(v.emoji); });

    // polls/predicts
    predictsRef.on('value', s => renderPredicts(s.val()||{}));
    pollsRef.on('value', s => renderPolls(s.val()||{}));
  }

  // tiny wrapper to detect if playing (YT vs html5)
  function pIsPlayingCustom(){ return usingYouTube ? (ytPlayer && ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) : (!html5video.paused); }

  // viewer sync with latency compensation + smooth correction
  function setupViewerSync(){
    roomRef.on('value', snap => {
      const data = snap.val();
      if(!data) return;

      lastServerUpdatedAt = data.updatedAt || Date.now();
      lastReceiveLocalTs = Date.now();

      const hostBase = data.currentTime || 0;
      const lagMs = Math.max(0, Date.now() - lastServerUpdatedAt);
      const hostEffective = hostBase + (lagMs / 1000);

      const localT = pGetTime();
      const diff = hostEffective - localT;

      // If big difference -> hard seek
      if(Math.abs(diff) > 2.0){
        try{ pSeek(hostEffective); } catch(e){}
      } else if(Math.abs(diff) > 0.05){
        // small difference -> gentle correction via small playbackRate adjustment
        // compute adjustment factor: if ahead (diff<0) slow down slightly; if behind (diff>0) speed up slightly
        const maxAdjust = 0.06; // max rate delta
        const factor = Math.max(-maxAdjust, Math.min(maxAdjust, diff * 0.05)); // tuned
        const targetRate = Math.max(0.85, Math.min(1.15, 1 + factor));
        pSetRate(targetRate);
        // also nudge time a little for stability
        try{ pSeek(localT + diff * 0.14); } catch(e){}
        // revert playbackRate back to normal gradually
        setTimeout(()=> pSetRate(data.hostPowers?.speed || 1), 800);
      } else {
        // tiny difference -> normal rate
        pSetRate(data.hostPowers?.speed || 1);
      }

      // apply play/pause
      if(data.status === 'play'){
        overlay.style.display = 'none';
        pPlay().catch(()=> showPlayPrompt());
      } else {
        overlay.style.display = 'block';
        pPause();
      }

      // apply speed
      if(data.hostPowers && data.hostPowers.speed) pSetRate(Number(data.hostPowers.speed));
    });

    // detect real buffering events and try recovery
    if(!usingYouTube){
      html5video.addEventListener('waiting', ()=>{ onBufferingEvent(); });
      html5video.addEventListener('stalled', ()=>{ onBufferingEvent(); });
    } else {
      // For YouTube, monitor player state transitions to detect repeated buffering
      // (YT has no direct 'waiting' event via iframe API; we rely on the prior fallback)
    }
  }

  // ---------- UI: host controls ----------
  function setupHostUI(){
    statusEl.textContent = 'Host (you control playback)';
    pauseDiscussBtn.addEventListener('click', ()=> {
      pPause();
      roomRef.update({ status:'pause', discussionOpen:true, updatedAt: firebase.database.ServerValue.TIMESTAMP });
    });

    drawBtn.addEventListener('click', ()=> {
      drawerToggle();
    });

    clearBtn.addEventListener('click', ()=> {
      // set flag and remove strokes node
      roomRef.child('clearDrawing').set(true);
      drawRef.remove().catch(()=>{});
      clearCanvas();
    });

    focusBtn.addEventListener('click', ()=> {
      roomRef.update({ hostPowers:{ focusMode:true }, updatedAt: firebase.database.ServerValue.TIMESTAMP });
      setTimeout(()=> roomRef.update({ hostPowers:{ focusMode:false } }), 5000);
    });

    speedSel.addEventListener('change', ()=> {
      const v = Number(speedSel.value || 1);
      pSetRate(v);
      roomRef.update({ hostPowers:{ speed: v }, updatedAt: firebase.database.ServerValue.TIMESTAMP });
    });

    predictBtn.addEventListener('click', ()=> {
      const q = prompt('Prediction question'); if(!q) return;
      const id = predictsRef.push().key;
      predictsRef.child(id).set({ question:q, createdAt: firebase.database.ServerValue.TIMESTAMP, options:{} });
    });

    pollBtn.addEventListener('click', ()=> {
      const q = prompt('Poll question'); if(!q) return;
      const id = pollsRef.push().key; pollsRef.child(id).set({ q, options:{}, createdAt: firebase.database.ServerValue.TIMESTAMP });
    });

    // HTML5 host events already wired earlier
  }

  // ---------- drawing ----------
  function drawerToggle(){
    drawerOn = !drawerOn;
    if(drawerOn && isHost){
      canvas.style.pointerEvents = 'auto';
      canvas.addEventListener('mousedown', onDown);
      canvas.addEventListener('mousemove', onMove);
      canvas.addEventListener('mouseup', onUp);
      canvas.addEventListener('touchstart', onDown);
      canvas.addEventListener('touchmove', onMove);
      canvas.addEventListener('touchend', onUp);
      drawBtn.textContent = 'Drawing ON';
    } else {
      canvas.style.pointerEvents = 'none';
      canvas.removeEventListener('mousedown', onDown);
      canvas.removeEventListener('mousemove', onMove);
      canvas.removeEventListener('mouseup', onUp);
      canvas.removeEventListener('touchstart', onDown);
      canvas.removeEventListener('touchmove', onMove);
      canvas.removeEventListener('touchend', onUp);
      drawBtn.textContent = 'Draw';
    }
  }

  function onDown(e){
    if(!isHost || !drawerOn) return;
    drawing = true;
    const r = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
    lastPos = { x, y };
  }
  function onMove(e){
    if(!drawing || !isHost) return;
    const r = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
    ctx.strokeStyle = '#ff0'; ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(lastPos.x, lastPos.y); ctx.lineTo(x, y); ctx.stroke();
    drawRef.push({ lx: lastPos.x / canvas.width, ly: lastPos.y / canvas.height, x: x / canvas.width, y: y / canvas.height, color:'#ff0', thickness:3, at: firebase.database.ServerValue.TIMESTAMP });
    lastPos = { x, y };
  }
  function onUp(){ drawing = false; lastPos = null; }

  function clearCanvas(){ ctx.clearRect(0,0,canvas.width,canvas.height); }

  // ---------- reactions ----------
  Array.from(document.querySelectorAll('#right button[data-emoji]')).forEach(b=>{
    b.addEventListener('click', ()=> {
      const emoji = b.getAttribute('data-emoji');
      reactionsRef.push({ emoji, at: firebase.database.ServerValue.TIMESTAMP });
    });
  });

  function showReaction(emoji){
    const el = document.createElement('div'); el.className = 'reaction'; el.textContent = emoji; document.getElementById('playerContainer').appendChild(el);
    setTimeout(()=> el.style.transform = 'translateY(-40px)', 20);
    setTimeout(()=> el.remove(), 3000);
  }

  // ---------- predictions & polls render ----------
  function renderPredicts(data){
    const out = document.getElementById('predictPanel'); out.innerHTML = '';
    for(const id in data){
      const p = data[id];
      const div = document.createElement('div'); div.style.marginTop='8px';
      div.innerHTML = `<strong>${p.question}</strong>`;
      const btn = document.createElement('button'); btn.className='btn grey'; btn.textContent='Answer';
      btn.onclick = ()=> { const a = prompt('Your answer'); if(!a) return; predictsRef.child(id).child('options').push({ uid: auth.currentUser?.uid||'anon', answer:a, at: firebase.database.ServerValue.TIMESTAMP }); };
      div.appendChild(btn); out.appendChild(div);
    }
  }
  function renderPolls(data){
    const out = document.getElementById('pollPanel'); out.innerHTML = '';
    for(const id in data){
      const p = data[id];
      const div = document.createElement('div'); div.style.marginTop='8px';
      div.innerHTML = `<strong>${p.q}</strong>`;
      const btn = document.createElement('button'); btn.className='btn grey'; btn.textContent='Vote';
      btn.onclick = ()=> { const v = prompt('Vote label'); if(!v) return; pollsRef.child(id).child('options').push({ uid: auth.currentUser?.uid||'anon', label:v, at: firebase.database.ServerValue.TIMESTAMP }); };
      div.appendChild(btn); out.appendChild(div);
    }
  }

  // ---------- fill canvas size ----------
  function fitCanvas(){
    const rect = (usingYouTube ? document.getElementById('player').getBoundingClientRect() : html5video.getBoundingClientRect());
    canvas.width = rect.width; canvas.height = rect.height;
    canvas.style.left = rect.left + 'px'; canvas.style.top = rect.top + 'px';
    // put playPrompt center
  }

  // ---------- autoplay permission ----------
  enablePlay.addEventListener('click', ()=> { pPlay(); playPrompt.style.display='none'; });

  // fullscreen
  fullscreen.addEventListener('click', ()=> {
    const el = document.documentElement;
    if (!document.fullscreenElement) {
      document.getElementById('playerContainer').requestFullscreen().catch(()=>{});
    } else document.exitFullscreen();
  });

  // prevent viewer manual interactions (HTML5)
  if(!isHost){
    html5video.addEventListener('seeking', ()=> { roomRef.once('value').then(s=> { const t=(s.val() && s.val().currentTime) || 0; html5video.currentTime = t; }); });
    html5video.addEventListener('play', ()=> { roomRef.once('value').then(s=>{ if(s.val() && s.val().status==='pause') html5video.pause(); }); });
  }

  // expose helper for agora whisper integration from UI
  // We also set up a separate hold mic UI if agora.js didn't create one
  function tryCreateHoldMicUI(){
    const controls = document.getElementById('agora-controls');
    if(!controls) return;
    // if agora.js already created a button (id mic-hold-btn) we skip
    if(document.getElementById('mic-hold-btn')) return;
    const b = document.createElement('button');
    b.id = 'mic-hold-local';
    b.className = 'btn';
    b.textContent = 'Hold to Talk';
    b.style.background = '#10b981';
    controls.appendChild(b);
    b.addEventListener('mousedown', ()=> { if(window.startWhisper) window.startWhisper(); });
    b.addEventListener('mouseup', ()=> { if(window.stopWhisper) window.stopWhisper(); });
    b.addEventListener('touchstart', ()=> { if(window.startWhisper) window.startWhisper(); });
    b.addEventListener('touchend', ()=> { if(window.stopWhisper) window.stopWhisper(); });
  }

  // after auth and after initAgoraVoice runs, try to create hold mic UI fallback
  setTimeout(()=> tryCreateHoldMicUI(), 2000);

  // expose some helpers for debugging
  window.__WP_roomId = roomId;
  window.__WP_helpers = { clearCanvas };

  </script>
</body>
</html>
